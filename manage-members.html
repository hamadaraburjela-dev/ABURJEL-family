<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الأفراد - عائلة أبو رجيلة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .container-fluid {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px 15px 0 15px;
        }

        .header {
            max-width: 1400px;
            margin: 0 auto;
            width: calc(100% - 30px);
            margin-top: 0;
            margin-bottom: 20px;
        }

        /* تحسينات للأجهزة الصغيرة */
        @media (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
            }
            
            .container-fluid {
                padding: 5px;
                max-width: 100%;
            }
            
            .main-content {
                width: 100%;
                margin: 5px 0;
                padding: 15px;
                border-radius: 15px;
            }
            
            .header {
                width: 100%;
                margin: 0 0 10px 0;
                padding: 10px;
                border-radius: 15px;
            }
            
            .stats-card {
                margin-bottom: 10px;
                padding: 15px;
                border-radius: 15px;
            }
            
            .stats-icon {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            
            .data-table-card {
                border-radius: 15px;
                margin: 0;
            }
            
            .search-filters {
                padding: 15px;
                border-radius: 10px;
            }
            
            .form-control {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .table-responsive {
                margin: 0 -10px;
                border-radius: 10px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-modern {
                font-size: 11px;
                min-width: 800px;
            }
            
            .table-modern th,
            .table-modern td {
                padding: 6px 4px;
                white-space: nowrap;
                min-width: 80px;
            }
            
            .table-modern th:first-child,
            .table-modern td:first-child {
                min-width: 60px;
            }
            
            .table-modern th:nth-child(3),
            .table-modern td:nth-child(3) {
                min-width: 120px;
            }
            
            .btn-group .btn {
                padding: 3px 6px;
                font-size: 10px;
            }
            
            .status-badge {
                font-size: 10px;
                padding: 4px 8px;
                min-width: 70px;
            }
            
            .header-title {
                font-size: 1.3rem !important;
            }
            
            .action-buttons .btn {
                padding: 6px 12px;
                font-size: 12px;
                margin: 2px;
            }
        }

        /* تحسينات للشاشات الصغيرة جداً */
        @media (max-width: 480px) {
            .container-fluid {
                padding: 2px;
            }
            
            .main-content {
                padding: 10px;
                margin: 2px 0;
            }
            
            .header {
                padding: 8px;
                flex-direction: column;
                text-align: center;
            }
            
            .header > div {
                margin-bottom: 10px;
            }
            
            .stats-card {
                padding: 12px;
            }
            
            .stats-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .search-filters .row {
                flex-direction: column;
            }
            
            .search-filters .col-md-4,
            .search-filters .col-md-3,
            .search-filters .col-md-2 {
                margin-bottom: 10px;
            }
            
            .card-header-modern {
                padding: 15px;
                flex-direction: column;
                text-align: center;
            }
            
            .action-buttons {
                margin-top: 10px;
                flex-direction: column;
            }
            
            .action-buttons .btn {
                margin: 2px 0;
                width: 100%;
            }
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 1400px;
            width: calc(100% - 30px);
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            border: none;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .stats-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .stats-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .stats-icon.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .stats-icon.warning {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: white;
        }
        
        .stats-icon.success {
            background: linear-gradient(135deg, #66bb6a, #4caf50);
            color: white;
        }
        
        .stats-icon.info {
            background: linear-gradient(135deg, #42a5f5, #2196f3);
            color: white;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .data-table-card {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
        }
        
        .card-header-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 30px;
        }
        
        .action-buttons .btn {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
            margin: 0 5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-buttons .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .action-buttons .btn:hover::before {
            left: 100%;
        }
        
        .search-filters {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .form-control {
            border-radius: 15px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            padding: 12px 20px;
            transition: all 0.3s ease;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        /* تحسينات اللمس للجوال */
        @media (hover: none) and (pointer: coarse) {
            .btn-modern:hover {
                transform: none;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }
            
            .stats-card:hover {
                transform: none;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            }
            
            .table-modern tbody tr:hover {
                background: rgba(102, 126, 234, 0.05);
                transform: none;
                box-shadow: none;
            }
        }

        /* تصميم الـ Pagination */
        .pagination-modern {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .pagination-modern .page-item {
            border: none;
            margin: 0 2px;
        }

        .pagination-modern .page-link {
            border: none;
            border-radius: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pagination-modern .page-link:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .pagination-modern .page-item.active .page-link {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .pagination-modern .page-item.disabled .page-link {
            background: rgba(255, 255, 255, 0.5);
            color: #aaa;
            cursor: not-allowed;
        }

        .pagination-info {
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* تحسينات للجوال */
        @media (max-width: 768px) {
            .pagination-modern .page-link {
                padding: 8px 10px;
                font-size: 12px;
                min-width: 36px;
            }
            
            .pagination-info {
                padding: 8px 15px;
                font-size: 12px;
            }
            
            #paginationContainer {
                flex-direction: column;
                gap: 15px;
            }
            
            .pagination-modern {
                justify-content: center;
            }
        }
        
        .table-modern {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .table-modern thead th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
        }
        
        .table-modern tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .table-modern tbody tr:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            text-align: center;
            min-width: 100px;
            display: inline-block;
        }
        
        .status-active {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .status-inactive {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
            color: white;
        }
        
        .loading-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 50px;
            text-align: center;
        }
        
        .spinner-modern {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 60px;
            text-align: center;
        }
        
        .modal-modern .modal-content {
            border: none;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .modal-modern .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 30px;
        }
        
        .btn-modern {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.3s;
        }
        
        .btn-modern:hover::before {
            left: 100%;
        }

        /* تحسينات إضافية */
        .logo-container {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        .table-row-hover:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* تأثير الكتابة للعنوان */
        .header-title {
            background: linear-gradient(45deg, #fff, #f0f0f0, #fff);
            background-size: 200% 200%;
            animation: textShine 3s ease-in-out infinite;
            -webkit-background-clip: text;
            background-clip: text;
        }

        @keyframes textShine {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* تأثير الدخول للكروت */
        .stats-card {
            animation: fadeInUp 0.6s ease-out;
        }

        .col-md-3:nth-child(1) .stats-card { animation-delay: 0.1s; }
        .col-md-3:nth-child(2) .stats-card { animation-delay: 0.2s; }
        .col-md-3:nth-child(3) .stats-card { animation-delay: 0.3s; }
        .col-md-3:nth-child(4) .stats-card { animation-delay: 0.4s; }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* تأثير الجدول */
        .data-table-card {
            animation: slideInUp 0.8s ease-out 0.5s both;
        }

        @keyframes slideInUp {
            0% {
                opacity: 0;
                transform: translateY(50px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* تحسينات الأزرار */
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* تأثير النبضة للإشعارات */
        .stats-icon.primary::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 2px solid #667eea;
            animation: ripple 2s ease-out infinite;
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .modern-footer {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px 0;
            margin-top: 40px;
        }

        .footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .footer-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .server-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .copyright-text {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin: 0;
        }

        .whatsapp-link {
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            background: rgba(37, 211, 102, 0.2);
            padding: 8px 15px;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .whatsapp-link:hover {
            background: rgba(37, 211, 102, 0.3);
            color: white;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <header class="header position-relative overflow-hidden">
            <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); backdrop-filter: blur(10px);"></div>
            <div class="d-flex align-items-center position-relative">
                <div class="logo-container me-3">
                    <img src="logo.webp" alt="شعار" class="header-logo rounded-circle shadow-sm" style="border: 3px solid rgba(255,255,255,0.3); width: 60px; height: 60px;">
                </div>
                <div>
                    <h1 class="header-title d-none d-sm-inline-block align-middle mb-0 text-white fw-700">إدارة الأفراد</h1>
                    <p class="text-white-50 mb-0 small d-none d-md-block">نظام إدارة بيانات أفراد العائلة</p>
                </div>
            </div>
            <div class="d-flex align-items-center position-relative">
                <button class="btn btn-outline-light btn-modern me-2" onclick="location.href='admin.html'">
                    <i class="bi bi-arrow-left me-1"></i>العودة للوحة التحكم
                </button>
                <button class="btn btn-danger btn-modern" onclick="sessionStorage.clear(); localStorage.clear(); location.href='index.html'">
                    <i class="bi bi-box-arrow-right me-1"></i>تسجيل الخروج
                </button>
            </div>
        </header>

        <main class="main-content">
            <!-- إحصائيات سريعة -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="stats-card text-center">
                        <div class="stats-icon primary">
                            <i class="bi bi-people-fill"></i>
                        </div>
                        <h3 class="fw-bold mb-1" id="totalMembers">0</h3>
                        <p class="text-muted mb-0 fw-500">إجمالي الأفراد</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="stats-card text-center">
                        <div class="stats-icon success">
                            <i class="bi bi-person-check-fill"></i>
                        </div>
                        <h3 class="fw-bold mb-1" id="activeMembers">0</h3>
                        <p class="text-muted mb-0 fw-500">أفراد نشطون</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="stats-card text-center">
                        <div class="stats-icon warning">
                            <i class="bi bi-person-x-fill"></i>
                        </div>
                        <h3 class="fw-bold mb-1" id="inactiveMembers">0</h3>
                        <p class="text-muted mb-0 fw-500">أفراد غير نشطين</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 col-sm-6 col-12">
                    <div class="stats-card text-center">
                        <div class="stats-icon info">
                            <i class="bi bi-calendar-plus-fill"></i>
                        </div>
                        <h3 class="fw-bold mb-1" id="newMembersThisMonth">0</h3>
                        <p class="text-muted mb-0 fw-500">مسجلون هذا الشهر</p>
                    </div>
                </div>
            </div>

            <!-- قائمة الأفراد -->
            <div class="data-table-card">
                <div class="card-header-modern d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-600">
                        <i class="bi bi-list-ul me-2"></i>قائمة أفراد العائلة
                    </h5>
                    <div class="action-buttons d-flex">
                        <button class="btn btn-outline-light btn-modern" onclick="refreshMembers()">
                            <i class="bi bi-arrow-clockwise me-1"></i>تحديث
                        </button>
                        <button class="btn btn-success btn-modern" onclick="exportToExcel()">
                            <i class="bi bi-file-earmark-excel me-1"></i>تصدير Excel
                        </button>
                        <button class="btn btn-primary btn-modern" onclick="addNewMember()">
                            <i class="bi bi-person-plus me-1"></i>إضافة فرد
                        </button>
                    </div>
                </div>
                <div class="card-body p-4">
                    <!-- فلاتر البحث -->
                    <div class="search-filters">
                        <div class="row g-3">
                            <div class="col-lg-4 col-md-6 col-12">
                                <div class="position-relative">
                                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                                    <input type="text" class="form-control ps-5" id="memberSearchInput" placeholder="البحث بالاسم أو رقم الهوية...">
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 col-12">
                                <select class="form-control" id="branchFilter">
                                    <option value="">جميع الفروع</option>
                                    <option value="ال احمد">آل أحمد</option>
                                    <option value="ال حامد">آل حامد</option>
                                    <option value="ال حمدان">آل حمدان</option>
                                    <option value="ال حماد">آل حماد</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 col-12">
                                <select class="form-control" id="statusFilter">
                                    <option value="">جميع الحالات</option>
                                    <option value="نشط">نشط</option>
                                    <option value="غير نشط">غير نشط</option>
                                </select>
                            </div>
                            <div class="col-lg-2 col-md-6 col-12">
                                <button class="btn btn-primary btn-modern w-100" onclick="applyFilters()">
                                    <i class="bi bi-funnel me-1"></i>فلترة
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- جدول الأفراد -->
                    <div class="table-responsive">
                        <table class="table table-modern">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-person-badge me-2"></i>الاسم الكامل</th>
                                    <th><i class="bi bi-card-text me-2"></i>رقم الهوية</th>
                                    <th><i class="bi bi-telephone me-2"></i>رقم الجوال</th>
                                    <th><i class="bi bi-geo-alt me-2"></i>مكان الإقامة</th>
                                    <th><i class="bi bi-activity me-2"></i>الحالة</th>
                                    <th><i class="bi bi-calendar me-2"></i>تاريخ التسجيل</th>
                                    <th><i class="bi bi-gear me-2"></i>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="membersTableBody">
                                <!-- سيتم ملؤها بواسطة JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div id="loadingSpinner" class="loading-container">
                        <div class="spinner-modern mx-auto mb-3"></div>
                        <h5 class="text-primary fw-600">جاري تحميل البيانات...</h5>
                        <p class="text-muted mb-0">يرجى الانتظار لحظات قليلة</p>
                    </div>

                    <div id="noData" class="no-data-container" style="display: none;">
                        <div class="mb-4">
                            <i class="bi bi-exclamation-triangle-fill display-1 text-warning opacity-75"></i>
                        </div>
                        <h4 class="text-muted fw-600 mb-2">فشل في تحميل البيانات</h4>
                        <p class="text-muted mb-3">تعذر الاتصال بقاعدة البيانات أو حدث خطأ في التحميل</p>
                        <button class="btn btn-primary btn-sm" onclick="loadMembersData()">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            إعادة المحاولة
                        </button>
                    </div>

                    <!-- نظام الصفحات -->
                    <div id="paginationContainer" class="d-flex justify-content-between align-items-center mt-4 pt-3" style="display: none !important;">
                        <div class="pagination-info">
                            <span class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                عرض <strong id="startItem">1</strong> - <strong id="endItem">10</strong> من أصل <strong id="totalItems">0</strong> عنصر
                            </span>
                        </div>
                        <nav aria-label="التنقل بين الصفحات">
                            <ul class="pagination pagination-modern mb-0" id="paginationList">
                                <!-- سيتم إنشاؤها بواسطة JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </main>
    
        <!-- Modal تفاصيل العضو -->
        <div class="modal fade modal-modern" id="memberDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-600">
                            <i class="bi bi-info-circle me-2"></i>تفاصيل بيانات العضو
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4" id="memberDetailsBody">
                        <!-- سيتم ملؤها بواسطة JavaScript -->
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn btn-secondary btn-modern" data-bs-dismiss="modal">إغلاق</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- نافذة تعديل العضو -->
        <div class="modal fade modal-modern" id="editMemberModal" tabindex="-1" aria-labelledby="editMemberModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-600" id="editMemberModalLabel">
                            <i class="bi bi-person-gear me-2"></i>تعديل بيانات العضو
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="editMemberForm">
                            <input type="hidden" id="editMemberId">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editFullName" class="form-label fw-600">
                                            <i class="bi bi-person-badge me-2"></i>الاسم الكامل
                                        </label>
                                        <input type="text" class="form-control" id="editFullName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editIdNumber" class="form-label fw-600">
                                            <i class="bi bi-card-text me-2"></i>رقم الهوية
                                        </label>
                                        <input type="text" class="form-control" id="editIdNumber" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editPhoneNumber" class="form-label fw-600">
                                            <i class="bi bi-telephone me-2"></i>رقم الجوال
                                        </label>
                                        <input type="text" class="form-control" id="editPhoneNumber" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editResidence" class="form-label fw-600">
                                            <i class="bi bi-geo-alt me-2"></i>مكان الإقامة
                                        </label>
                                        <input type="text" class="form-control" id="editResidence" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editBranch" class="form-label fw-600">
                                            <i class="bi bi-building me-2"></i>الفرع
                                        </label>
                                        <select class="form-control" id="editBranch">
                                            <option value="ال احمد">آل أحمد</option>
                                            <option value="ال حامد">آل حامد</option>
                                            <option value="ال حمدان">آل حمدان</option>
                                            <option value="ال حماد">آل حماد</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editStatus" class="form-label fw-600">
                                            <i class="bi bi-activity me-2"></i>الحالة
                                        </label>
                                        <select class="form-control" id="editStatus">
                                            <option value="نشط">نشط</option>
                                            <option value="غير نشط">غير نشط</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editSpouseId" class="form-label fw-600">
                                            <i class="bi bi-card-text me-2"></i>رقم هوية الزوجة
                                        </label>
                                        <input type="text" class="form-control" id="editSpouseId">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="editSpouseFullName" class="form-label fw-600">
                                            <i class="bi bi-person-heart me-2"></i>اسم الزوجة الكامل
                                        </label>
                                        <input type="text" class="form-control" id="editSpouseFullName">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn btn-secondary btn-modern" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>إلغاء
                        </button>
                        <button type="button" class="btn btn-primary btn-modern" onclick="updateMember()">
                            <i class="bi bi-check-circle me-2"></i>حفظ التغييرات
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- نافذة إضافة عضو جديد -->
        <div class="modal fade modal-modern" id="addMemberModal" tabindex="-1" aria-labelledby="addMemberModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-600" id="addMemberModalLabel">
                            <i class="bi bi-person-plus me-2"></i>إضافة فرد جديد
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="addMemberForm">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newFullName" class="form-label fw-600">
                                            <i class="bi bi-person-badge me-2"></i>الاسم الكامل
                                        </label>
                                        <input type="text" class="form-control" id="newFullName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newIdNumber" class="form-label fw-600">
                                            <i class="bi bi-card-text me-2"></i>رقم الهوية
                                        </label>
                                        <input type="text" class="form-control" id="newIdNumber" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newPhoneNumber" class="form-label fw-600">
                                            <i class="bi bi-telephone me-2"></i>رقم الجوال
                                        </label>
                                        <input type="text" class="form-control" id="newPhoneNumber" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newResidence" class="form-label fw-600">
                                            <i class="bi bi-geo-alt me-2"></i>مكان الإقامة
                                        </label>
                                        <input type="text" class="form-control" id="newResidence" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newBranch" class="form-label fw-600">
                                            <i class="bi bi-building me-2"></i>الفرع
                                        </label>
                                        <select class="form-control" id="newBranch">
                                            <option value="ال احمد">آل أحمد</option>
                                            <option value="ال حامد">آل حامد</option>
                                            <option value="ال حمدان">آل حمدان</option>
                                            <option value="ال حماد">آل حماد</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newStatus" class="form-label fw-600">
                                            <i class="bi bi-activity me-2"></i>الحالة
                                        </label>
                                        <select class="form-control" id="newStatus">
                                            <option value="نشط" selected>نشط</option>
                                            <option value="غير نشط">غير نشط</option>
                                        </select>
                                        <small class="form-text text-muted">
                                            <i class="bi bi-info-circle me-1"></i>
                                            الأعضاء غير النشطين لا يمكنهم الوصول للموقع
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newSpouseId" class="form-label fw-600">
                                            <i class="bi bi-card-text me-2"></i>رقم هوية الزوجة
                                        </label>
                                        <input type="text" class="form-control" id="newSpouseId">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="newSpouseFullName" class="form-label fw-600">
                                            <i class="bi bi-person-heart me-2"></i>اسم الزوجة الكامل
                                        </label>
                                        <input type="text" class="form-control" id="newSpouseFullName">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn btn-secondary btn-modern" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>إلغاء
                        </button>
                        <button type="button" class="btn btn-success btn-modern" onclick="addMember()">
                            <i class="bi bi-check-circle me-2"></i>إضافة العضو
                        </button>
                    </div>
                </div>
            </div>
        </div>        <!-- نافذة تقرير العضو -->
        <div class="modal fade modal-modern" id="printReportModal" tabindex="-1" aria-labelledby="printReportModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-xl">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-600" id="printReportModalLabel">
                            <i class="bi bi-file-earmark-text me-2"></i>تقرير العضو
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4" id="printReportContentWrapper">
                        <div id="printReportContent" class="print-content">
                        </div>
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn btn-secondary btn-modern" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>إغلاق
                        </button>
                        <button type="button" class="btn btn-primary btn-modern" id="startPrintBtn">
                            <i class="bi bi-printer-fill me-2"></i>طباعة التقرير
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- نافذة تغيير الحالة -->
        <div class="modal fade modal-modern" id="statusUpdateModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-600">
                            <i class="bi bi-gear me-2"></i>تغيير حالة العضو
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="mb-3">
                            <label for="newStatusSelect" class="form-label fw-600">الحالة الجديدة:</label>
                            <select class="form-control" id="newStatusSelect">
                                <option value="نشط">نشط</option>
                                <option value="غير نشط">غير نشط</option>
                            </select>
                        </div>
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>تنبيه:</strong> الأعضاء غير النشطين لن يتمكنوا من الوصول إلى الموقع أو تسجيل الدخول.
                        </div>
                        <input type="hidden" id="currentMemberId">
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn btn-secondary btn-modern" data-bs-dismiss="modal">إلغاء</button>
                        <button type="button" class="btn btn-primary btn-modern" onclick="updateMemberStatus()">تحديث الحالة</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- نافذة التأكيد -->
        <div class="modal fade modal-modern" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title fw-600" id="confirmationModalLabel">
                            <i class="bi bi-exclamation-triangle me-2"></i>تأكيد الإجراء
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="text-center">
                            <div class="mb-3">
                                <i class="bi bi-question-circle-fill display-3 text-warning"></i>
                            </div>
                            <div id="confirmationModalBody" class="fs-5">
                                هل أنت متأكد من هذا الإجراء؟
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 px-4 pb-4">
                        <button type="button" class="btn btn-secondary btn-modern" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle me-2"></i>إلغاء
                        </button>
                        <button type="button" class="btn btn-danger btn-modern" id="confirmActionBtn">
                            <i class="bi bi-check-circle me-2"></i>تأكيد
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- التذييل الحديث -->
        <footer class="modern-footer">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="server-status" id="server-status">
                        <div class="status-indicator">
                            <span class="status-dot"></span>
                            <span class="status-text">جاري التحقق من حالة الخادم...</span>
                        </div>
                    </div>
                </div>
                <div class="footer-section text-center">
                    <p class="copyright-text">
                        جميع الحقوق محفوظة &copy; 2025 | م. حماده أبو رجيلة
                    </p>
                </div>
                <div class="footer-section">
                    <a href="https://wa.me/972569210941" target="_blank" class="whatsapp-link">
                        <i class="bi bi-whatsapp me-2"></i>تواصل عبر الواتساب
                    </a>
                </div>
            </div>
        </footer>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>
    <script>
        let membersData = [];
        let filteredMembers = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // التحقق من تسجيل الدخول
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking authentication...');
            
            // التحقق من تسجيل دخول المدير
            const adminToken = sessionStorage.getItem('adminToken');
            
            if (!adminToken) {
                console.log('No admin token found, redirecting to login');
                // في حالة عدم وجود توكن، توجه للصفحة الرئيسية
                // window.location.href = 'index.html';
                // return;
                
                console.log('Running in production mode');
            } else {
                console.log('Admin token found, proceeding with data load');
            }
            
            loadMembersData();
        });

        // تحميل بيانات الأفراد
        async function loadMembersData() {
            // إضافة تأثير التحميل
            const loadingElement = document.getElementById('loadingSpinner');
            const tableBody = document.getElementById('membersTableBody');
            const noDataElement = document.getElementById('noData');
            
            // إخفاء الجدول وإظهار شاشة التحميل مع تأثير fade
            if (tableBody) {
                tableBody.style.opacity = '0';
                tableBody.style.transition = 'opacity 0.3s ease';
            }
            
            loadingElement.style.display = 'block';
            noDataElement.style.display = 'none';
            loadingElement.style.opacity = '0';
            setTimeout(() => { loadingElement.style.opacity = '1'; }, 100);
            
            try {
                const token = sessionStorage.getItem('adminToken');
                console.log('Loading members data with token:', token ? 'exists' : 'missing');
                
                let response = null;
                
                // التحقق من وجود كائن App وخصائصه
                if (typeof App !== 'undefined' && App && typeof App.postToAPI === 'function') {
                    console.log('Using App.postToAPI method');
                    response = await App.postToAPI({ action: 'getAllMembers', token, searchTerm: '', page: 1, pageSize: 1000 });
                } else if (typeof App !== 'undefined' && App && App.WEB_APP_URL) {
                    console.log('Using fallback fetch with App.WEB_APP_URL');
                    // Fallback direct fetch using shared WEB_APP_URL
                    const res = await fetch(App.WEB_APP_URL, {
                        method: 'POST',
                        mode: 'cors',
                        redirect: 'follow',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'getAllMembers', token, searchTerm: '', page: 1, pageSize: 1000 })
                    });
                    const text = await res.text();
                    console.log('Raw response:', text);
                    try {
                        response = JSON.parse(text);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError, 'Raw text:', text);
                        throw new Error('خطأ في تحليل الاستجابة من الخادم');
                    }
                } else {
                    console.warn('App object not found or incomplete, using demo data');
                    // استخدام بيانات تجريبية في حالة عدم وجود App
                    response = {
                        success: true,
                        data: generateDemoMembersData()
                    };
                }
                
                console.log('Response received:', response);
                
                if (response && response.success) {
                    // getAllMembers يعيد البيانات في response.members بدلاً من response.data
                    membersData = response.members || response.data || [];
                    console.log('Raw members data received:', membersData);
                    
                    // ترتيب البيانات بحسب تاريخ التسجيل (الأحدث أولاً)
                    membersData.sort((a, b) => {
                        const dateA = new Date(a['تاريخ التسجيل'] || a.registrationDate || 0);
                        const dateB = new Date(b['تاريخ التسجيل'] || b.registrationDate || 0);
                        return dateB - dateA; // الأحدث أولاً
                    });
                    filteredMembers = [...membersData];
                    currentPage = 1; // إعادة تعيين الصفحة للأولى
                    console.log('Members data loaded and sorted:', membersData.length, 'items');
                    
                    // تأخير بسيط لإظهار التأثير البصري
                    setTimeout(() => {
                        renderMembers();
                        updateStatistics();
                        
                        // إخفاء شاشة التحميل مع تأثير fade وإظهار الجدول
                        loadingElement.style.opacity = '0';
                        setTimeout(() => {
                            loadingElement.style.display = 'none';
                            if (tableBody) {
                                tableBody.style.opacity = '1';
                            }
                        }, 300);
                        
                        // صوت إشعار النجاح (اختياري)
                        try {
                            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFA==');
                            audio.volume = 0.1;
                            audio.play().catch(() => {}); // تجاهل الخطأ إذا لم يُسمح بتشغيل الصوت
                        } catch (e) {
                            // تجاهل أخطاء الصوت
                        }
                    }, 800);
                } else {
                    const errorMsg = response?.message || 'فشل في تحميل البيانات من الخادم';
                    console.error('Server response error:', errorMsg);
                    throw new Error(errorMsg);
                }
            } catch (error) {
                console.error('Error loading members data:', error);
                
                // في حالة الخطأ، نستخدم البيانات التجريبية كحل بديل
                console.warn('Failed to load data from server, falling back to demo data');
                
                membersData = generateDemoMembersData();
                filteredMembers = [...membersData];
                currentPage = 1;
                
                // إخفاء شاشة التحميل وعرض البيانات التجريبية
                setTimeout(() => {
                    renderMembers();
                    updateStatistics();
                    
                    loadingElement.style.opacity = '0';
                    setTimeout(() => {
                        loadingElement.style.display = 'none';
                        if (tableBody) {
                            tableBody.style.opacity = '1';
                        }
                    }, 300);
                    
                    // إشعار بأننا نستخدم بيانات تجريبية
                    if (typeof Toastify !== 'undefined') {
                        Toastify({
                            text: `تم تحميل البيانات التجريبية (خطأ في الاتصال: ${error.message})`,
                            duration: 5000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "linear-gradient(to right, #ffa726, #ff9800)",
                        }).showToast();
                    }
                }, 800);
            }
        }

        // إنتاج بيانات تجريبية للاختبار
        function generateDemoMembersData() {
            const demoMembers = [];
            const names = [
                // فرع آل أحمد
                'أحمد محمد أبو رجيلة', 'محمد أحمد أبو رجيلة', 'سالم أحمد أبو رجيلة', 'حسن أحمد أبو رجيلة',
                'فاطمة أحمد أبو رجيلة', 'عائشة أحمد أبو رجيلة', 'مريم أحمد أبو رجيلة',
                // فرع آل حامد
                'حامد علي أبو رجيلة', 'محمد حامد أبو رجيلة', 'يوسف حامد أبو رجيلة', 'إبراهيم حامد أبو رجيلة',
                'زينب حامد أبو رجيلة', 'نور حامد أبو رجيلة', 'هدى حامد أبو رجيلة',
                // فرع آل حمدان
                'حمدان سعيد أبو رجيلة', 'عمر حمدان أبو رجيلة', 'خالد حمدان أبو رجيلة', 'سليم حمدان أبو رجيلة',
                'آمنة حمدان أبو رجيلة', 'رقية حمدان أبو رجيلة', 'حليمة حمدان أبو رجيلة',
                // فرع آل حماد
                'حماد يوسف أبو رجيلة', 'عبد الرحمن حماد أبو رجيلة', 'صالح حماد أبو رجيلة', 'طارق حماد أبو رجيلة',
                'سعاد حماد أبو رجيلة', 'ليلى حماد أبو رجيلة', 'وفاء حماد أبو رجيلة'
            ];
            
            const residences = ['غزة', 'رفح', 'خان يونس', 'دير البلح', 'النصيرات', 'جباليا'];
            const branches = ['ال احمد', 'ال حامد', 'ال حمدان', 'ال حماد'];
            
            // توزيع الأسماء على الفروع
            const branchNames = {
                'ال احمد': names.slice(0, 7),    // أول 7 أسماء
                'ال حامد': names.slice(7, 14),   // التالية 7 أسماء
                'ال حمدان': names.slice(14, 21), // التالية 7 أسماء
                'ال حماد': names.slice(21, 28)   // آخر 7 أسماء
            };

            branches.forEach((branch, branchIndex) => {
                const branchMemberNames = branchNames[branch];
                const membersPerBranch = Math.floor(25 / branches.length) + (branchIndex < 25 % branches.length ? 1 : 0);
                
                for (let i = 0; i < membersPerBranch; i++) {
                    const registrationDate = new Date();
                    registrationDate.setDate(registrationDate.getDate() - Math.floor(Math.random() * 365));
                    
                    const memberName = branchMemberNames[i % branchMemberNames.length];
                    const status = Math.random() > 0.8 ? 'غير نشط' : 'نشط'; // 20% غير نشطين
                    
                    demoMembers.push({
                        'الاسم الكامل': memberName,
                        'رقم الهوية': `40${String(Math.floor(Math.random() * 9000000) + 1000000)}`,
                        'رقم الجوال': `059${String(Math.floor(Math.random() * 9000000) + 1000000)}`,
                        'مكان الإقامة': residences[Math.floor(Math.random() * residences.length)],
                        'الفرع': branch,
                        'الحالة': status,
                        'تاريخ التسجيل': registrationDate.toISOString().split('T')[0],
                        'رقم هوية الزوجة': Math.random() > 0.5 ? `40${String(Math.floor(Math.random() * 9000000) + 1000000)}` : '',
                        'اسم الزوجة الكامل': Math.random() > 0.5 ? 'زوجة ' + branchMemberNames[Math.floor(Math.random() * branchMemberNames.length)] : ''
                    });
                }
            });
            
            return demoMembers;
        }

        // عرض الأفراد في الجدول
        function renderMembers() {
            const tbody = document.getElementById('membersTableBody');
            const noDataElement = document.getElementById('noData');
            
            if (!tbody) return;
            
            if (!filteredMembers.length) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">لا توجد نتائج</td></tr>';
                noDataElement.style.display = 'block';
                document.getElementById('paginationContainer').style.display = 'none';
                return;
            }
            
            noDataElement.style.display = 'none';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredMembers.length);
            const pageMembers = filteredMembers.slice(startIndex, endIndex);
            
            tbody.innerHTML = pageMembers.map((member, index) => {
                const fullName = member['الاسم الكامل'] || member.fullName || 'غير محدد';
                const idNumber = member['رقم الهوية'] || member.idNumber || 'غير محدد';
                const phoneNumber = member['رقم الجوال'] || member.phoneNumber || 'غير محدد';
                const residence = member['مكان الإقامة'] || member.residence || 'غير محدد';
                const status = member['الحالة'] || member.status || 'نشط';
                const registrationDate = member['تاريخ التسجيل'] || member.registrationDate || '';
                
                // التعامل مع الحالات باللغة العربية والإنجليزية
                let statusBadge;
                if (status === 'نشط' || status === 'Active') {
                    statusBadge = '<span class="status-badge status-active"><i class="bi bi-check-circle me-1"></i>نشط</span>';
                } else if (status === 'غير نشط' || status === 'Inactive') {
                    statusBadge = '<span class="status-badge status-inactive"><i class="bi bi-x-circle me-1"></i>غير نشط</span>';
                } else {
                    statusBadge = '<span class="status-badge status-active"><i class="bi bi-check-circle me-1"></i>نشط</span>'; // افتراضي
                }
                
                const formattedDate = registrationDate ? new Date(registrationDate).toLocaleDateString('ar') : 'غير محدد';
                
                return `
                    <tr class="table-row-hover">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                                    <i class="bi bi-person-fill text-white"></i>
                                </div>
                                <strong class="text-dark">${fullName}</strong>
                            </div>
                        </td>
                        <td><span class="font-monospace bg-light px-2 py-1 rounded">${idNumber}</span></td>
                        <td>${phoneNumber}</td>
                        <td>${residence}</td>
                        <td>${statusBadge}</td>
                        <td>${formattedDate}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-info btn-modern" title="عرض التفاصيل" onclick="showMemberDetails(${startIndex + index})">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning btn-modern" title="تعديل" onclick="editMember(${startIndex + index})">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary btn-modern" title="تغيير الحالة" onclick="changeStatus(${startIndex + index})">
                                    <i class="bi bi-toggle-on"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-modern" title="حذف" onclick="deleteMember(${startIndex + index})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updatePagination();
        }

        // تحديث الإحصائيات
        function updateStatistics() {
            const totalMembers = membersData.length;
            const activeMembers = membersData.filter(m => {
                const status = m['الحالة'] || m.status || 'نشط';
                return status === 'نشط' || status === 'Active';
            }).length;
            const inactiveMembers = totalMembers - activeMembers;
            
            // حساب الأفراد المسجلين هذا الشهر
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const newMembersThisMonth = membersData.filter(m => {
                const regDate = new Date(m['تاريخ التسجيل'] || m.registrationDate || 0);
                return regDate.getMonth() === currentMonth && regDate.getFullYear() === currentYear;
            }).length;
            
            // تحديث العناصر مع تأثير العد التصاعدي
            animateCounter('totalMembers', totalMembers);
            animateCounter('activeMembers', activeMembers);
            animateCounter('inactiveMembers', inactiveMembers);
            animateCounter('newMembersThisMonth', newMembersThisMonth);
        }

        // تأثير العد التصاعدي للأرقام
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            let currentValue = 0;
            const increment = Math.ceil(targetValue / 20);
            const timer = setInterval(() => {
                currentValue += increment;
                if (currentValue >= targetValue) {
                    currentValue = targetValue;
                    clearInterval(timer);
                }
                element.textContent = currentValue;
            }, 50);
        }

        // تحديث نظام الصفحات
        function updatePagination() {
            const totalPages = Math.ceil(filteredMembers.length / itemsPerPage);
            const paginationContainer = document.getElementById('paginationContainer');
            const paginationList = document.getElementById('paginationList');
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            // تحديث معلومات العرض
            const startItem = filteredMembers.length > 0 ? (currentPage - 1) * itemsPerPage + 1 : 0;
            const endItem = Math.min(currentPage * itemsPerPage, filteredMembers.length);
            
            document.getElementById('startItem').textContent = startItem;
            document.getElementById('endItem').textContent = endItem;
            document.getElementById('totalItems').textContent = filteredMembers.length;
            
            // إنشاء أزرار الصفحات
            let paginationHTML = '';
            
            // زر السابق
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            paginationHTML += `
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">
                        <i class="bi bi-chevron-right me-1"></i>
                        <span class="d-none d-sm-inline">السابق</span>
                    </a>
                </li>
            `;
            
            // أرقام الصفحات
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">1</a></li>`;
                if (startPage > 2) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'active' : '';
                paginationHTML += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="changePage(${i})">${i}</a></li>`;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                paginationHTML += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a></li>`;
            }
            
            // زر التالي
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            paginationHTML += `
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">
                        <span class="d-none d-sm-inline">التالي</span>
                        <i class="bi bi-chevron-left ms-1"></i>
                    </a>
                </li>
            `;
            
            paginationList.innerHTML = paginationHTML;
        }

        // تغيير الصفحة
        function changePage(page) {
            const totalPages = Math.ceil(filteredMembers.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderMembers();
            
            // التمرير إلى أعلى الجدول
            document.querySelector('.data-table-card').scrollIntoView({
                behavior: 'smooth',
                block: 'start'
            });
        }

        // تطبيق الفلاتر
        function applyFilters() {
            const searchTerm = document.getElementById('memberSearchInput').value.toLowerCase().trim();
            const selectedBranch = document.getElementById('branchFilter').value;
            const selectedStatus = document.getElementById('statusFilter').value;
            
            filteredMembers = membersData.filter(member => {
                const fullName = (member['الاسم الكامل'] || member.fullName || '').toLowerCase();
                const idNumber = (member['رقم الهوية'] || member.idNumber || '').toString();
                const branch = member['الفرع'] || member.branch || '';
                const status = member['الحالة'] || member.status || 'نشط';
                
                const matchesSearch = !searchTerm || 
                    fullName.includes(searchTerm) || 
                    idNumber.includes(searchTerm);
                    
                const matchesBranch = !selectedBranch || branch === selectedBranch;
                
                // مطابقة الحالة (دعم العربية والإنجليزية)
                let matchesStatus = true;
                if (selectedStatus) {
                    if (selectedStatus === 'نشط') {
                        matchesStatus = (status === 'نشط' || status === 'Active');
                    } else if (selectedStatus === 'غير نشط') {
                        matchesStatus = (status === 'غير نشط' || status === 'Inactive');
                    } else {
                        matchesStatus = status === selectedStatus;
                    }
                }
                
                return matchesSearch && matchesBranch && matchesStatus;
            });
            
            currentPage = 1;
            renderMembers();
        }

        // تحديث البيانات
        function refreshMembers() {
            if (typeof Toastify !== 'undefined') {
                Toastify({
                    text: "جاري تحديث البيانات...",
                    duration: 2000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "linear-gradient(to right, #667eea, #764ba2)",
                }).showToast();
            }
            loadMembersData();
        }

        // تصدير إلى Excel
        function exportToExcel() {
            if (!filteredMembers.length) {
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "لا توجد بيانات للتصدير",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #ff9a9e, #fecfef)",
                    }).showToast();
                }
                return;
            }
            
            try {
                const ws = XLSX.utils.json_to_sheet(filteredMembers);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "أفراد العائلة");
                
                const filename = `افراد_العائلة_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, filename);
                
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "تم تصدير البيانات بنجاح!",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    }).showToast();
                }
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "حدث خطأ أثناء التصدير",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    }).showToast();
                }
            }
        }

        // إضافة مستمعي الأحداث للفلاتر
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('memberSearchInput');
            const branchFilter = document.getElementById('branchFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(applyFilters, 300);
                });
            }
            
            if (branchFilter) branchFilter.addEventListener('change', applyFilters);
            if (statusFilter) statusFilter.addEventListener('change', applyFilters);
        });



        // عرض تفاصيل العضو
        function showMemberDetails(index) {
            const member = filteredMembers[index];
            if (!member) return;
            
            const detailsHTML = `
                <div class="row g-4">
                    <div class="col-12">
                        <div class="text-center mb-4">
                            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                                <i class="bi bi-person-fill text-white" style="font-size: 2.5rem;"></i>
                            </div>
                            <h4 class="fw-bold">${member['الاسم الكامل'] || 'غير محدد'}</h4>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <strong><i class="bi bi-card-text me-2"></i>رقم الهوية:</strong>
                            <span class="font-monospace">${member['رقم الهوية'] || 'غير محدد'}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <strong><i class="bi bi-telephone me-2"></i>رقم الجوال:</strong>
                            <span>${member['رقم الجوال'] || 'غير محدد'}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <strong><i class="bi bi-geo-alt me-2"></i>مكان الإقامة:</strong>
                            <span>${member['مكان الإقامة'] || 'غير محدد'}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <strong><i class="bi bi-building me-2"></i>الفرع:</strong>
                            <span>${member['الفرع'] || 'غير محدد'}</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <strong><i class="bi bi-activity me-2"></i>الحالة:</strong>
                            ${(() => {
                                const status = member['الحالة'] || member.status || 'نشط';
                                if (status === 'نشط' || status === 'Active') {
                                    return '<span class="status-badge status-active"><i class="bi bi-check-circle me-1"></i>نشط</span>';
                                } else if (status === 'غير نشط' || status === 'Inactive') {
                                    return '<span class="status-badge status-inactive"><i class="bi bi-x-circle me-1"></i>غير نشط</span>';
                                } else {
                                    return '<span class="status-badge status-active"><i class="bi bi-check-circle me-1"></i>نشط</span>';
                                }
                            })()}
                            ${(() => {
                                const status = member['الحالة'] || member.status || 'نشط';
                                if (status === 'غير نشط' || status === 'Inactive') {
                                    return '<div class="alert alert-warning mt-2 mb-0"><i class="bi bi-exclamation-triangle me-1"></i>هذا العضو لا يستطيع الوصول للموقع</div>';
                                }
                                return '';
                            })()}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-item">
                            <strong><i class="bi bi-calendar me-2"></i>تاريخ التسجيل:</strong>
                            <span>${member['تاريخ التسجيل'] ? new Date(member['تاريخ التسجيل']).toLocaleDateString('ar') : 'غير محدد'}</span>
                        </div>
                    </div>
                    ${member['رقم هوية الزوجة'] ? `
                        <div class="col-md-6">
                            <div class="info-item">
                                <strong><i class="bi bi-card-text me-2"></i>رقم هوية الزوجة:</strong>
                                <span class="font-monospace">${member['رقم هوية الزوجة']}</span>
                            </div>
                        </div>
                    ` : ''}
                    ${member['اسم الزوجة الكامل'] ? `
                        <div class="col-md-6">
                            <div class="info-item">
                                <strong><i class="bi bi-person-heart me-2"></i>اسم الزوجة:</strong>
                                <span>${member['اسم الزوجة الكامل']}</span>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <style>
                    .info-item {
                        padding: 15px;
                        background: rgba(0,0,0,0.03);
                        border-radius: 10px;
                        margin-bottom: 10px;
                    }
                    .info-item strong {
                        display: block;
                        color: #333;
                        margin-bottom: 5px;
                    }
                </style>
            `;
            
            document.getElementById('memberDetailsBody').innerHTML = detailsHTML;
            new bootstrap.Modal(document.getElementById('memberDetailsModal')).show();
        }

        // تعديل بيانات العضو
        function editMember(index) {
            const member = filteredMembers[index];
            if (!member) return;
            
            // ملء النموذج بالبيانات الحالية
            document.getElementById('editMemberId').value = index;
            document.getElementById('editFullName').value = member['الاسم الكامل'] || '';
            document.getElementById('editIdNumber').value = member['رقم الهوية'] || '';
            document.getElementById('editPhoneNumber').value = member['رقم الجوال'] || '';
            document.getElementById('editResidence').value = member['مكان الإقامة'] || '';
            document.getElementById('editBranch').value = member['الفرع'] || 'ال احمد';
            // تحديد الحالة مع دعم العربية والإنجليزية
            const currentStatus = member['الحالة'] || member.status || 'نشط';
            if (currentStatus === 'Active') {
                document.getElementById('editStatus').value = 'نشط';
            } else if (currentStatus === 'Inactive') {
                document.getElementById('editStatus').value = 'غير نشط';
            } else {
                document.getElementById('editStatus').value = currentStatus;
            }
            document.getElementById('editSpouseId').value = member['رقم هوية الزوجة'] || '';
            document.getElementById('editSpouseFullName').value = member['اسم الزوجة الكامل'] || '';
            
            new bootstrap.Modal(document.getElementById('editMemberModal')).show();
        }

        // تغيير حالة العضو
        function changeStatus(index) {
            const member = filteredMembers[index];
            if (!member) return;
            
            document.getElementById('currentMemberId').value = index;
            
            // تحديد الحالة الحالية مع دعم العربية والإنجليزية
            const currentStatus = member['الحالة'] || member.status || 'نشط';
            if (currentStatus === 'Active') {
                document.getElementById('newStatusSelect').value = 'نشط';
            } else if (currentStatus === 'Inactive') {
                document.getElementById('newStatusSelect').value = 'غير نشط';
            } else {
                document.getElementById('newStatusSelect').value = currentStatus;
            }
            
            new bootstrap.Modal(document.getElementById('statusUpdateModal')).show();
        }

        // حذف العضو
        function deleteMember(index) {
            const member = filteredMembers[index];
            if (!member) return;
            
            document.getElementById('confirmationModalBody').textContent = 
                `هل أنت متأكد من حذف العضو "${member['الاسم الكامل'] || 'غير محدد'}"؟`;
            
            const confirmBtn = document.getElementById('confirmActionBtn');
            confirmBtn.onclick = function() {
                console.log('Deleting member in demo mode:', member);
                
                // حذف العضو من البيانات المحلية
                const memberIdToDelete = member['رقم الهوية'];
                membersData = membersData.filter(m => m['رقم الهوية'] !== memberIdToDelete);
                filteredMembers = filteredMembers.filter(m => m['رقم الهوية'] !== memberIdToDelete);
                
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "تم حذف العضو بنجاح (وضع تجريبي)",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    }).showToast();
                }
                
                // تحديث العرض
                renderMembers();
                updateStatistics();
                
                bootstrap.Modal.getInstance(document.getElementById('confirmationModal')).hide();
            };
            
            new bootstrap.Modal(document.getElementById('confirmationModal')).show();
        }

        // إضافة عضو جديد
        function addNewMember() {
            // مسح النموذج
            document.getElementById('addMemberForm').reset();
            document.getElementById('newStatus').value = 'نشط'; // جميع الأعضاء الجدد نشطين افتراضياً
            document.getElementById('newBranch').value = 'ال احمد'; // القيمة الافتراضية
            
            new bootstrap.Modal(document.getElementById('addMemberModal')).show();
        }

        // تحديث بيانات العضو
        async function updateMember() {
            const index = document.getElementById('editMemberId').value;
            const member = filteredMembers[index];
            
            if (!member) return;
            
            // جمع البيانات المحدثة
            const updatedData = {
                'الاسم الكامل': document.getElementById('editFullName').value.trim(),
                'رقم الهوية': document.getElementById('editIdNumber').value.trim(),
                'رقم الجوال': document.getElementById('editPhoneNumber').value.trim(),
                'مكان الإقامة': document.getElementById('editResidence').value.trim(),
                'الفرع': document.getElementById('editBranch').value,
                'الحالة': document.getElementById('editStatus').value,
                'رقم هوية الزوجة': document.getElementById('editSpouseId').value.trim(),
                'اسم الزوجة الكامل': document.getElementById('editSpouseFullName').value.trim(),
                'memberId': member['رقم الهوية'] || member.id
            };
            
            // التحقق من صحة البيانات
            if (!updatedData['الاسم الكامل'] || !updatedData['رقم الهوية'] || !updatedData['رقم الجوال'] || !updatedData['مكان الإقامة']) {
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "يرجى ملء جميع الحقول المطلوبة",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #f44336, #d32f2f)",
                    }).showToast();
                }
                return;
            }
            
            // تحديث العضو في الوضع التجريبي
            console.log('Updating member in demo mode:', updatedData);
            
            // العثور على العضو وتحديثه في البيانات المحلية
            const originalId = member['رقم الهوية'];
            const memberIndexInData = membersData.findIndex(m => m['رقم الهوية'] === originalId);
            const memberIndexInFiltered = filteredMembers.findIndex(m => m['رقم الهوية'] === originalId);
            
            if (memberIndexInData !== -1) {
                // تحديث البيانات مع الاحتفاظ بتاريخ التسجيل
                const originalDate = membersData[memberIndexInData]['تاريخ التسجيل'];
                membersData[memberIndexInData] = { ...updatedData, 'تاريخ التسجيل': originalDate };
                delete membersData[memberIndexInData].memberId;
            }
            
            if (memberIndexInFiltered !== -1) {
                const originalDate = filteredMembers[memberIndexInFiltered]['تاريخ التسجيل'];
                filteredMembers[memberIndexInFiltered] = { ...updatedData, 'تاريخ التسجيل': originalDate };
                delete filteredMembers[memberIndexInFiltered].memberId;
            }
            
            if (typeof Toastify !== 'undefined') {
                        Toastify({
                            text: "تم تحديث بيانات العضو بنجاح",
                            duration: 3000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                        text: "تم تحديث بيانات العضو بنجاح (وضع تجريبي)",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                    }).showToast();
                }
                
                // تحديث العرض
                renderMembers();
                updateStatistics();
                
                // إغلاق النافذة
                bootstrap.Modal.getInstance(document.getElementById('editMemberModal')).hide();
        }

        // تحديث حالة العضو
        async function updateMemberStatus() {
            const index = document.getElementById('currentMemberId').value;
            const newStatus = document.getElementById('newStatusSelect').value;
            const member = filteredMembers[index];
            
            if (!member) return;
            
            try {
                console.log('Updating member status to:', newStatus);
                
                // إرسال التحديث للخادم
                const result = await App.callServerFunction('updateMemberStatus', {
                    memberId: member['رقم الهوية'] || member.id,
                    status: newStatus
                });
                
                if (result && result.success) {
                    // إشعار مؤقت مع تنبيه حول الوصول
                    if (typeof Toastify !== 'undefined') {
                        const statusText = newStatus === 'نشط' ? 'نشط' : 'غير نشط';
                        const accessNote = newStatus === 'غير نشط' 
                            ? ' - لن يتمكن من الوصول للموقع' 
                            : ' - يمكنه الوصول للموقع';
                            
                        const backgroundColor = newStatus === 'نشط' 
                            ? "linear-gradient(to right, #00b09b, #96c93d)"
                            : "linear-gradient(to right, #ff9a9e, #fad0c4)";
                        
                        Toastify({
                            text: `تم تغيير حالة العضو إلى "${statusText}"${accessNote}`,
                            duration: 5000,
                            gravity: "top",
                            position: "center",
                            backgroundColor: backgroundColor,
                        }).showToast();
                    }
                    
                    // إعادة تحميل البيانات
                    loadMembersData();
                } else {
                    throw new Error(result.error || 'فشل في تحديث حالة العضو');
                }
            } catch (error) {
                console.error('Error updating member status:', error);
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "خطأ في تحديث حالة العضو: " + error.message,
                        duration: 5000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #f44336, #d32f2f)",
                    }).showToast();
                }
            }
            
            bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal')).hide();
        }

        // إضافة عضو جديد
        async function addMember() {
            // التحقق من صحة البيانات
            const fullName = document.getElementById('newFullName').value.trim();
            const idNumber = document.getElementById('newIdNumber').value.trim();
            const phoneNumber = document.getElementById('newPhoneNumber').value.trim();
            const residence = document.getElementById('newResidence').value.trim();
            const branch = document.getElementById('newBranch').value;
            const status = document.getElementById('newStatus').value;
            
            // التحقق من الحقول المطلوبة
            if (!fullName || !idNumber || !phoneNumber || !residence || !branch) {
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "يرجى ملء جميع الحقول المطلوبة",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #f44336, #d32f2f)",
                    }).showToast();
                }
                return;
            }
            
            // التحقق من صحة رقم الهوية (9 أرقام)
            if (!/^\d{9}$/.test(idNumber)) {
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "رقم الهوية يجب أن يكون 9 أرقام",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #f44336, #d32f2f)",
                    }).showToast();
                }
                return;
            }
            
            // التحقق من صحة رقم الجوال (يبدأ بـ 059 ويتكون من 10 أرقام)
            if (!/^059\d{7}$/.test(phoneNumber)) {
                if (typeof Toastify !== 'undefined') {
                    Toastify({
                        text: "رقم الجوال يجب أن يبدأ بـ 059 ويتكون من 10 أرقام",
                        duration: 3000,
                        gravity: "top",
                        position: "center",
                        backgroundColor: "linear-gradient(to right, #f44336, #d32f2f)",
                    }).showToast();
                }
                return;
            }
            
            const newMemberData = {
                'الاسم الكامل': fullName,
                'رقم الهوية': idNumber,
                'رقم الجوال': phoneNumber,
                'مكان الإقامة': residence,
                'الفرع': branch,
                'الحالة': status,
                'تاريخ التسجيل': new Date().toISOString().split('T')[0],
                'رقم هوية الزوجة': document.getElementById('newSpouseId').value.trim(),
                'اسم الزوجة الكامل': document.getElementById('newSpouseFullName').value.trim()
            };
            
            console.log('Adding new member:', newMemberData);
            
            // في الوضع التجريبي، نضيف العضو محلياً
            console.log('Adding new member in demo mode:', newMemberData);
            
            // محاكاة إضافة العضو للبيانات المحلية
            membersData.unshift(newMemberData); // إضافة في المقدمة
            filteredMembers = [...membersData];
            
            if (typeof Toastify !== 'undefined') {
                Toastify({
                    text: "تم إضافة العضو الجديد بنجاح (وضع تجريبي)",
                    duration: 3000,
                    gravity: "top",
                    position: "center",
                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                }).showToast();
            }
            
            // تحديث العرض
            renderMembers();
            updateStatistics();
            
            // إغلاق النافذة وإعادة تعيين النموذج
            bootstrap.Modal.getInstance(document.getElementById('addMemberModal')).hide();
            document.getElementById('addMemberForm').reset();
        }
    </script>
</body>
</html>