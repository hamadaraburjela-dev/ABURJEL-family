<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إدارة الإصابات - عائلة أبو رجيلى</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container-fluid">
    <header class="header py-3 d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <img src="logo.webp" alt="شعار" style="width:72px;height:72px;margin-left:12px;border-radius:12px;"/>
        <div>
          <h3 class="mb-0">إدارة الإصابات</h3>
          <small class="text-muted">قائمة الإبلاغ عن الإصابات والتعامل الإداري</small>
        </div>
      </div>
      <div>
        <button class="btn btn-outline-secondary me-2" onclick="location.href='admin.html'">العودة للإدارة</button>
        <button class="btn btn-danger" onclick="sessionStorage.clear(); location.href='index.html'">تسجيل الخروج</button>
      </div>
    </header>

    <main class="main-content">
      <div class="data-table-card">
        <div class="card-header-modern d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="bi bi-list-ul me-2"></i>بلاغات الإصابات</h5>
          <div class="action-buttons">
            <button class="btn btn-outline-light" onclick="refreshInjuries()"><i class="bi bi-arrow-clockwise me-1"></i>تحديث</button>
            <button class="btn btn-success" onclick="exportInjuries()"><i class="bi bi-file-earmark-excel me-1"></i>تصدير Excel</button>
          </div>
        </div>

        <div class="card-body p-4">
          <div class="search-filters mb-3">
            <div class="row g-3">
              <div class="col-md-4">
                <input id="injurySearchInput" class="form-control" placeholder="بحث بالاسم أو رقم الهوية..." />
              </div>
              <div class="col-md-3">
                <select id="injuryStatusFilter" class="form-control">
                  <option value="">كل الحالات</option>
                  <option value="جديد">جديد</option>
                  <option value="قيد المراجعة">قيد المراجعة</option>
                  <option value="معالج">معالج</option>
                </select>
              </div>
              <div class="col-md-2">
                <button class="btn btn-primary w-100" onclick="applyInjuryFilters()"><i class="bi bi-funnel me-1"></i>فلترة</button>
              </div>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-modern">
              <thead>
                <tr>
                  <th>#</th>
                  <th>تاريخ الإبلاغ</th>
                  <th>اسم المصاب</th>
                  <th>رقم الهوية</th>
                  <th>تاريخ الإصابة</th>
                  <th>مكان الإصابة</th>
                  <th>سبب الإصابة</th>
                  <th>الحالة</th>
                  <th>إجراءات</th>
                </tr>
              </thead>
              <tbody id="injuriesTableBody">
                <tr><td colspan="9" class="text-center text-muted">جارٍ التحميل...</td></tr>
              </tbody>
            </table>
          </div>

          <div id="injuryPaginationContainer" class="d-flex justify-content-between align-items-center mt-4" style="display:none;">
            <div class="pagination-info">
              <span class="text-muted">عرض <strong id="injStartItem">0</strong> - <strong id="injEndItem">0</strong> من <strong id="injTotalItems">0</strong></span>
            </div>
            <nav><ul class="pagination pagination-modern mb-0" id="injPaginationList"></ul></nav>
          </div>

        </div>
      </div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="script.js"></script>

  <script>
    let injuryRecords = [];
    let filteredInjuries = [];
    let injCurrentPage = 1;
    const injPerPage = 10;

    document.addEventListener('DOMContentLoaded', function(){
      loadInjuries();
      document.getElementById('injurySearchInput').addEventListener('input', function(){ setTimeout(applyInjuryFilters, 250); });
      document.getElementById('injuryStatusFilter').addEventListener('change', applyInjuryFilters);
    });

    async function loadInjuries(){
      const table = document.getElementById('injuriesTableBody');
      table.innerHTML = '<tr><td colspan="9" class="text-center">جارٍ التحميل...</td></tr>';
      try{
        const token = sessionStorage.getItem('adminToken');
        const res = await App.postToAPI({ action: 'getInjuryRequests', token });
        if (!res || !res.success) throw new Error(res?.message || 'فشل التحميل');
        injuryRecords = res.data || [];
        filteredInjuries = [...injuryRecords];
        injCurrentPage = 1;
        renderInjuries();
      }catch(err){
        App.showToast(err.message||'خطأ في تحميل البلاغات', false);
        document.getElementById('injuriesTableBody').innerHTML = '<tr><td colspan="9" class="text-center text-danger">'+(err.message||'خطأ')+'</td></tr>';
      }
    }

    function applyInjuryFilters(){
      const q = document.getElementById('injurySearchInput').value.trim().toLowerCase();
      const status = document.getElementById('injuryStatusFilter').value;
      filteredInjuries = injuryRecords.filter(r=>{
        const name = (r['\u0627\u0633\u0645 \u0627\u0644\u0627\u0635\u0627\u0628']||'').toString().toLowerCase();
        const id = (r['\u0631\u0642\u0645 \u0627\u0644\u0645\u0635\u0627\u0628']||'').toString().toLowerCase();
        const matchesQ = !q || name.includes(q) || id.includes(q);
        const matchesStatus = !status || (r['\u062d\u0627\u0644\u0629']||'') === status;
        return matchesQ && matchesStatus;
      });
      injCurrentPage = 1; renderInjuries();
    }

    function renderInjuries(){
      const tbody = document.getElementById('injuriesTableBody');
      if (!filteredInjuries.length){ tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">لا توجد بلاغات</td></tr>'; document.getElementById('injuryPaginationContainer').style.display='none'; return; }
      const start = (injCurrentPage-1)*injPerPage; const end = Math.min(start+injPerPage, filteredInjuries.length);
      const page = filteredInjuries.slice(start,end);
      tbody.innerHTML = page.map(rec=>{
        const regDate = new Date(rec['\u062a\u0627\u0631\u064a\u062e \u0627\u0644\u062a\u0633\u062c\u064a\u0644']||rec['date']||'').toLocaleDateString('ar-EG');
        const injDate = new Date(rec['\u062a\u0627\u0631\u064a\u062e \u0627\u0644\u0625\u0635\u0627\u0628\u0629']||'').toLocaleDateString('ar-EG');
        return `<tr class="table-row-hover">\n<td><span class="badge bg-primary rounded-pill">#${rec['\u0645\u0639\u0631\u0641 \u0627\u0644\u0637\u0644\u0628']}</span></td>\n<td>${regDate}</td>\n<td><strong>${rec['\u0645\u0639\u0631\u0641 \u0627\u0644\u0645\u0635\u0627\u0628']||rec['\u0627\u0633\u0645 \u0627\u0644\u0627\u0635\u0627\u0628']||'-'}</strong></td>\n<td><code>${rec['\u0631\u0642\u0645 \u0627\u0644\u0645\u0635\u0627\u0628']||'-'}</code></td>\n<td>${injDate}</td>\n<td>${rec['\u0645\u0643\u0627\u0646 \u0627\u0644\u0625\u0635\u0627\u0628\u0629']||'-'}</td>\n<td>${rec['\u0633\u0628\u0628 \u0627\u0644\u0625\u0635\u0627\u0628\u0629']||'-'}</td>\n<td><span class="badge bg-${rec['\u062d\u0627\u0644\u0629']==='معالج'?'success':rec['\u062d\u0627\u0644\u0629']==='قيد المراجعة'?'warning':'secondary'}">${rec['\u062d\u0627\u0644\u0629']||'جديد'}</span></td>\n<td><div class="btn-group"><button class="btn btn-sm btn-outline-info" onclick="viewInjury('${rec['\u0645\u0639\u0631\u0641 \u0627\u0644\u0637\u0644\u0628']}')"><i class="bi bi-eye"></i></button><button class="btn btn-sm btn-outline-warning" onclick="openInjuryStatusModal('${rec['\u0645\u0639\u0631\u0641 \u0627\u0644\u0637\u0644\u0628']}', '${rec['\u062d\u0627\u0644\u0629']||''}')"><i class="bi bi-gear"></i></button>${rec['\u0631\u0627\u0628\u0637 \u0627\u0644\u0645\u0644\u0641']?`<a class="btn btn-sm btn-outline-success" href="${rec['\u0631\u0627\u0628\u0637 \u0627\u0644\u0645\u0644\u0641']}" target="_blank"><i class="bi bi-file-earmark-pdf"></i></a>`:''}</div></td>\n</tr>`;
      }).join('');

      document.getElementById('injStartItem').textContent = start+1; document.getElementById('injEndItem').textContent = end; document.getElementById('injTotalItems').textContent = filteredInjuries.length;
      renderInjuryPagination(); document.getElementById('injuryPaginationContainer').style.display='flex';
    }

    function renderInjuryPagination(){
      const totalPages = Math.ceil(filteredInjuries.length / injPerPage);
      const list = document.getElementById('injPaginationList'); list.innerHTML='';
      const addBtn = (txt, enabled, fn, active=false)=>{ const li=document.createElement('li'); li.className=`page-item ${active? 'active':''} ${!enabled? 'disabled':''}`; const a=document.createElement('a'); a.className='page-link'; a.href='#'; a.textContent=txt; if(enabled) a.addEventListener('click', (e)=>{e.preventDefault(); fn();}); li.appendChild(a); list.appendChild(li); };
      addBtn('<', injCurrentPage>1, ()=>{ injCurrentPage--; renderInjuries(); });
      let start = Math.max(1, injCurrentPage-2); let end = Math.min(totalPages, injCurrentPage+2);
      if(start>1){ addBtn('1', true, ()=>{ injCurrentPage=1; renderInjuries(); }); if(start>2){ const dots=document.createElement('li'); dots.className='page-item disabled'; dots.innerHTML='<span class="page-link">...</span>'; list.appendChild(dots); } }
      for(let i=start;i<=end;i++){ addBtn(i, true, ()=>{ injCurrentPage=i; renderInjuries(); }, i===injCurrentPage); }
      if(end<totalPages){ if(end<totalPages-1){ const dots=document.createElement('li'); dots.className='page-item disabled'; dots.innerHTML='<span class="page-link">...</span>'; list.appendChild(dots); } addBtn(totalPages, true, ()=>{ injCurrentPage=totalPages; renderInjuries(); }); }
      addBtn('>', injCurrentPage<totalPages, ()=>{ injCurrentPage++; renderInjuries(); });
    }

    async function refreshInjuries(){ await loadInjuries(); App.showToast('تم تحديث البلاغات', true); }

    function viewInjury(id){ const rec = injuryRecords.find(r=> String(r['\u0645\u0639\u0631\u0641 \u0627\u0644\u0637\u0644\u0628'])===String(id)); if(!rec) return; let html = `<div class="p-3">`;
      html += `<p><strong>اسم المصاب: </strong>${rec['\u0645\u0639\u0631\u0641 \u0627\u0644\u0645\u0635\u0627\u0628']||'-'}</p>`;
      html += `<p><strong>رقم الهوية: </strong>${rec['\u0631\u0642\u0645 \u0627\u0644\u0645\u0635\u0627\u0628']||'-'}</p>`;
      html += `<p><strong>تاريخ الإصابة: </strong>${new Date(rec['\u062a\u0627\u0631\u064a\u062e \u0627\u0644\u0625\u0635\u0627\u0628\u0629']||'').toLocaleDateString()}</p>`;
      html += `<p><strong>مكان الإصابة: </strong>${rec['\u0645\u0643\u0627\u0646 \u0627\u0644\u0625\u0635\u0627\u0628\u0629']||'-'}</p>`;
      html += `<p><strong>سبب الإصابة: </strong>${rec['\u0633\u0628\u0628 \u0627\u0644\u0625\u0635\u0627\u0628\u0629']||'-'}</p>`;
      if(rec['\u0631\u0627\u0628\u0637 \u0627\u0644\u0645\u0644\u0641']) html += `<p><a href="${rec['\u0631\u0627\u0628\u0637 \u0627\u0644\u0645\u0644\u0641']}" target="_blank" class="btn btn-sm btn-outline-success">عرض الملف المرفق</a></p>`;
      html += `</div>`;
      App.showDialog({ title: 'تفاصيل البلاغ', message: html, type: 'info' });
    }

    function openInjuryStatusModal(requestId, currentStatus){ const body = document.createElement('div'); body.innerHTML = `\n      <div class="mb-3">\n        <label class="form-label">الحالة الجديدة</label>\n        <select id="newInjuryStatus" class="form-control">\n          <option value="جديد">جديد</option>\n          <option value="قيد المراجعة">قيد المراجعة</option>\n          <option value="معالج">معالج</option>\n        </select>\n      </div>`;
      App.showDialog({ title: 'تغيير حالة البلاغ', message: body, type: 'warning', confirmText: 'تحديث' });
      setTimeout(()=>{ document.getElementById('newInjuryStatus').value = currentStatus || 'جديد'; const confirmBtn = document.querySelector('#appDialogConfirm'); confirmBtn.onclick = async function(){ const newStatus = document.getElementById('newInjuryStatus').value; const token = sessionStorage.getItem('adminToken'); const res = await App.postToAPI({ action: 'updateInjuryRequestStatus', token, requestId, newStatus }); if(res && res.success){ App.showToast(res.message||'تم التحديث', true); await loadInjuries(); } }; }, 120);
    }

    function exportInjuries(){ if(!filteredInjuries.length){ App.showToast('لا توجد بيانات للتصدير', false); return; } const ws = XLSX.utils.json_to_sheet(filteredInjuries); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '\u0627\u0635\u0627\u0628\u0627\u062a'); XLSX.writeFile(wb, `اصابات-${new Date().toLocaleDateString('ar-EG')}.xlsx`); App.showToast('تم تصدير البيانات بنجاح', true); }
  </script>
</body>
</html>
