<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุชุณุฌูู ุงูููุงููุฏ - ุนุงุฆูุฉ ุฃุจู ุฑุฌููุฉ</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh;">
  
  <!-- Header -->
  <header class="text-center py-4">
    <div class="container">
      <img src="logo.webp" alt="ุดุนุงุฑ ุนุงุฆูุฉ ุฃุจู ุฑุฌููุฉ" class="mb-3" style="width: 80px; height: 80px;" />
      <h1 class="h3 mb-2">ุนุงุฆูุฉ ุฃุจู ุฑุฌููุฉ (ูุฏูุญ)</h1>
      <!-- ุฑุณุงูุฉ ูู ุงูุนุงุฆูุฉ -->
      <div class="mt-5 mx-auto" style="max-width: 700px;">
        <div class="card shadow-lg border-0 pulse-card" style="border-radius: 20px; overflow: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ff6b9d 100%);">
          <!DOCTYPE html>
          <html lang="ar" dir="rtl">
          <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <title>ุชุณุฌูู ุจูุฒุท ุฃุทูุงู</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
            <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
            <link rel="stylesheet" href="style.css" />
          </head>
          <body style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh;">
            <header class="text-center py-4">
              <div class="container">
                <img src="logo.webp" alt="ุดุนุงุฑ ุนุงุฆูุฉ ุฃุจู ุฑุฌููุฉ" class="mb-3" style="width:80px;height:80px" />
                <h1 class="h3 mb-2">ุนุงุฆูุฉ ุฃุจู ุฑุฌููุฉ (ูุฏูุญ)</h1>
                <p class="text-muted">ุชุณุฌูู ุงุญุชูุงุฌุงุช ุจูุฒุท/ููุงุจุณ ุงูุฃุทูุงู</p>
              </div>
            </header>

            <main class="container" style="max-width:900px;">
              <div class="card shadow-lg" style="border-radius: 15px; border: none;">
                <div class="card-header text-center" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px 15px 0 0;">
                  <h2 class="mb-0">๐ง ุชุณุฌูู ุจูุฒุท ุฃุทูุงู</h2>
                  <small class="opacity-75">ุงููุฃ ุงููููุฐุฌ ุงูุชุงูู ูุฅุฑุณุงู ุทูุจู</small>
                </div>
                <div class="card-body p-4">
                  <form id="clothesForm" class="needs-validation" novalidate>
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label fw-bold">ุฑูู ุงููููุฉ<span class="text-danger"> *</span></label>
                        <input id="idNumber" class="form-control" maxlength="9" pattern="[0-9]{9}" placeholder="9 ุฃุฑูุงู" required />
                        <div class="invalid-feedback">ุฃุฏุฎู ุฑูู ูููุฉ ุตุญูุญ (9 ุฃุฑูุงู)</div>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">ุงูุงุณู ุงููุงูู<span class="text-danger"> *</span></label>
                        <input id="fullName" class="form-control" placeholder="ุงุณู ุฑุจุงุนู" required />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">ุฑูู ุงูุฌูุงู<span class="text-danger"> *</span></label>
                        <input id="phone" class="form-control" placeholder="05XXXXXXXX" required />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">ููุงู ุงูุฅูุงูุฉ</label>
                        <input id="address" class="form-control" placeholder="ุงูููุทูุฉ / ุงูุดุงุฑุน" />
                      </div>
                      <div class="col-md-4">
                        <label class="form-label fw-bold">ุนุฏุฏ ุงูุฃุทูุงู<span class="text-danger"> *</span></label>
                        <input id="childrenCount" type="number" min="1" class="form-control" placeholder="ูุซุงู: 3" required />
                        <div class="invalid-feedback">ุฃุฏุฎู ุนุฏุฏุงู ุตุญูุญุงู</div>
                      </div>
                      <div class="col-md-8">
                        <label class="form-label fw-bold">ุชูุงุตูู ุงูููุงุณุงุช</label>
                        <textarea id="sizesDetails" class="form-control" rows="2" placeholder="ูุซุงู: ุนูุฑ 5 ุณููุงุช (L)ุ ุนูุฑ 8 ุณููุงุช (XL)..."></textarea>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">ุงูุฃููููุฉ</label>
                        <select id="priority" class="form-select">
                          <option value="ุนุงุฏู" selected>ุนุงุฏู</option>
                          <option value="ูุชูุณุท">ูุชูุณุท</option>
                          <option value="ุนุงุฌู">ุนุงุฌู</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label fw-bold">ูุฑูู (ุงุฎุชูุงุฑู)</label>
                        <input id="attachment" type="file" class="form-control" accept="image/*,.pdf" />
                      </div>
                      <div class="col-12">
                        <label class="form-label fw-bold">ููุงุญุธุงุช</label>
                        <textarea id="notes" class="form-control" rows="2"></textarea>
                      </div>
                    </div>
                    <div class="d-flex justify-content-end gap-2 mt-4">
                      <a href="wounded-form.html" class="btn btn-outline-secondary">ุนูุฏุฉ</a>
                      <button type="submit" class="btn btn-primary">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        <span class="button-text">ุฅุฑุณุงู ุงูุทูุจ</span>
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            </main>

            <footer class="footer">
              <div id="server-status" class="status-indicator mb-2">
                <span class="status-dot"></span>
                <span class="status-text">ุฌุงุฑู ุงูุชุญูู ูู ุญุงูุฉ ุงูุฎุงุฏู...</span>
              </div>
              <p class="copyright-text mb-2">ุฌููุน ุงูุญููู ูุญููุธุฉ &copy; 2025 | ู. ุญูุงุฏู ุฃุจู ุฑุฌููุฉ</p>
              <a href="https://wa.me/972569210941" target="_blank" class="whatsapp-link">
                <i class="bi bi-whatsapp"></i> ุชูุงุตู ุนุจุฑ ุงููุงุชุณุงุจ
              </a>
            </footer>

            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
            <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
            <script src="script.js"></script>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('clothesForm');
                const attachmentInput = document.getElementById('attachment');

                const WEB_APP_URL = (window.App && App.WEB_APP_URL)
                  ? App.WEB_APP_URL
                  : 'https://script.google.com/macros/s/AKfycbxiyJpbfDqZzpOoBuVEnOPJvsfzV8QT9-6M4wMNe23vzIl251xFI5jVNGtWrfcjp4OplQ/exec';

                const toBase64Payload = (file) => new Promise((resolve) => {
                  if (!file) { resolve(null); return; }
                  const reader = new FileReader();
                  reader.onload = () => {
                    const result = reader.result;
                    const base64Data = String(result).substring(String(result).indexOf(',') + 1);
                    resolve({ name: file.name, mimeType: file.type, data: base64Data });
                  };
                  reader.onerror = () => resolve(null);
                  reader.readAsDataURL(file);
                });

                async function postJson(payload) {
                  const res = await fetch(WEB_APP_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
                  const raw = await res.text();
                  let data = null;
                  try { data = raw ? JSON.parse(raw) : null; } catch { data = null; }
                  if (!res.ok) {
                    const snippet = raw ? raw.slice(0, 200) : '';
                    throw new Error((data && data.message) || snippet || `HTTP ${res.status}`);
                  }
                  if (!data) {
                    const snippet = raw ? raw.slice(0, 200) : '';
                    const looksHtml = /^\s*<!DOCTYPE|^\s*<html|^\s*<HTML/i.test(snippet);
                    const authHint = /Authorization|login|Sign in|requires authentication|OAuth/i.test(snippet);
                    const hint = looksHtml && authHint ? 'ูุญุชุงุฌ ุงูุชุทุจูู ูุฅุนุงุฏุฉ ูุดุฑ/ุชูููุถ ุตูุงุญูุงุช.' : '';
                    throw new Error(hint || 'ุฑุฏ ุบูุฑ ุตุงูุญ ูู ุงูุฎุงุฏู.');
                  }
                  return data;
                }

                // Only digits for id/phone
                document.getElementById('idNumber').addEventListener('input', e => e.target.value = e.target.value.replace(/[^0-9]/g, ''));
                document.getElementById('phone').addEventListener('input', e => e.target.value = e.target.value.replace(/[^0-9+]/g, ''));

                form.addEventListener('submit', async (e) => {
                  e.preventDefault();
                  if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
                  const btn = form.querySelector('button[type="submit"]');
                  const spinner = btn.querySelector('.spinner-border');
                  const textSpan = btn.querySelector('.button-text');
                  spinner.classList.remove('d-none');
                  btn.disabled = true;
                  textSpan.textContent = 'ุฌุงุฑู ุงูุฅุฑุณุงู...';

                  try {
                    const attachment = await toBase64Payload(attachmentInput.files[0]);
                    const payload = {
                      action: 'submitChildrenClothes',
                      idNumber: document.getElementById('idNumber').value,
                      fullName: document.getElementById('fullName').value,
                      phone: document.getElementById('phone').value,
                      address: document.getElementById('address').value,
                      childrenCount: document.getElementById('childrenCount').value,
                      sizesDetails: document.getElementById('sizesDetails').value,
                      priority: document.getElementById('priority').value,
                      notes: document.getElementById('notes').value,
                      attachment
                    };
                    const result = await postJson(payload);
                    if (!result.success) throw new Error(result.message || 'ูุดู ุฅุฑุณุงู ุงูุทูุจ');
                    if (window.App && App.showDialog) {
                      App.showDialog({ type: 'success', title: 'ุชู ุฅุฑุณุงู ุงูุทูุจ', message: result.message || 'ุชู ุงุณุชูุงู ุทูุจู.' });
                    } else if (window.App && App.showToast) {
                      App.showToast(result.message || 'ุชู ุงุณุชูุงู ุงูุทูุจ.', true);
                    }
                    form.reset();
                    form.classList.remove('was-validated');
                  } catch (err) {
                    if (window.App && App.showDialog) {
                      App.showDialog({ type: 'danger', title: 'ุชุนุฐูุฑ ุงูุฅุฑุณุงู', message: err.message || 'ุญุฏุซ ุฎุทุฃ ุบูุฑ ูุชููุน.' });
                    } else if (window.App && App.showToast) {
                      App.showToast(err.message || 'ุชุนุฐูุฑ ุงูุฅุฑุณุงู', false);
                    } else {
                      console.error(err);
                    }
                  } finally {
                    spinner.classList.add('d-none');
                    btn.disabled = false;
                    textSpan.textContent = 'ุฅุฑุณุงู ุงูุทูุจ';
                  }
                });
              });
            </script>
          </body>
          </html>
    ? App.WEB_APP_URL
