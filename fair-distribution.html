<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التوزيع العادل</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
        }
        .header-bg {
            background-color: #1e3a8a;
            color: #ffffff;
            border-bottom-left-radius: 2rem;
            border-bottom-right-radius: 2rem;
        }
        .modern-input {
            background-color: #f9fafb;
            border-color: #e5e7eb;
            transition: border-color 0.3s ease;
        }
        .modern-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .btn-primary {
            background-color: #1e3a8a;
            border-color: #1e3a8a;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
            transform: translateY(-2px);
        }
        .btn-success {
            background-color: #059669;
            border-color: #059669;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-success:hover {
            background-color: #047857;
            transform: translateY(-2px);
        }
        .header-btn {
            background-color: #3b82f6;
            color: #ffffff;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
        }
        .footer-bg {
            background-color: #1e3a8a;
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <div class="header-bg py-4 px-6 mb-8 shadow-lg">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <img src="https://placehold.co/64x64/ffffff/1e3a8a?text=LOGO" alt="شعار" class="rounded-full w-12 h-12 shadow-md">
                <h1 class="text-2xl font-bold mr-4 hidden sm:block">نظام التوزيع العادل للمساعدات</h1>
            </div>
            <div class="flex items-center space-x-2 rtl:space-x-reverse">
                <a href="admin.html" class="header-btn hover:bg-blue-600">العودة للوحة التحكم</a>
                <a href="index.html" onclick="sessionStorage.clear(); localStorage.clear();" class="header-btn hover:bg-red-600">تسجيل الخروج</a>
            </div>
        </div>
    </div>

    <main class="flex-grow">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 lg:grid-cols-1 gap-8">
                <!-- Distribution System Card -->
                <div class="card p-6 mb-8">
                    <div class="flex items-center text-xl font-bold text-gray-800 border-b pb-4 mb-4">
                        <i class="bi bi-arrow-left-right ml-2 text-blue-500"></i>
                        <h5>نظام التوزيع العادل</h5>
                    </div>
                    <form id="distributionForm">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label for="totalAid" class="block text-sm font-bold text-gray-700 mb-2">إجمالي عدد المساعدات المتاحة</label>
                                <input type="number" class="modern-input w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" id="totalAid" placeholder="مثال: 150" required>
                            </div>
                            <div>
                                <label for="distributionType" class="block text-sm font-bold text-gray-700 mb-2">نوع التوزيع</label>
                                <select class="modern-input w-full p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" id="distributionType">
                                    <option value="equal">توزيع متساوي</option>
                                    <option value="proportional">توزيع نسبي حسب عدد العائلات</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-6">
                            <h6 class="text-lg font-bold text-gray-600 mb-4">بيانات الفروع</h6>
                            <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800">
                                <strong class="block mb-1">كيفية عمل التوزيع النسبي:</strong>
                                <ul class="list-disc list-inside space-y-1">
                                    <li><strong>بدون تخصيص:</strong> اترك الحقل فارغاً، سيتم التوزيع حسب عدد العائلات.</li>
                                    <li><strong>مع تخصيص:</strong> أدخل أرقام أكبر لزيادة حصة الفرع، أو أصغر لتقليلها.</li>
                                    <li><strong>مثال:</strong> إذا كان عدد العائلات 10، وأدخلت 15، ستزيد حصة الفرع بنسبة 50%.</li>
                                </ul>
                            </div>
                            <div id="branchesContainer" class="mt-4 space-y-4">
                                <!-- سيتم إضافة الفروع هنا ديناميكياً -->
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn-success px-8 py-3 rounded-full text-white text-lg font-bold shadow-lg hover:shadow-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                <i class="bi bi-calculator ml-2"></i>
                                حساب التوزيع
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Results Card -->
                <div class="card p-6 mb-8" id="resultsCard" style="display: none;">
                    <div class="flex items-center text-xl font-bold text-gray-800 border-b pb-4 mb-4">
                        <i class="bi bi-check-circle ml-2 text-green-500"></i>
                        <h5>نتائج التوزيع</h5>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h6 class="text-lg font-bold text-gray-600 mb-3">تفاصيل التوزيع</h6>
                            <div id="distributionResults" class="space-y-3"></div>
                        </div>
                        <div>
                            <h6 class="text-lg font-bold text-gray-600 mb-3">الرسم البياني</h6>
                            <canvas id="distributionChart" class="w-full"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer-bg text-center py-4 mt-8 shadow-inner">
        <div id="server-status" class="status-indicator text-sm flex items-center justify-center mb-2">
            <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse ml-2"></span>
            <span class="status-text">جاري التحقق من حالة الخادم...</span>
        </div>
        <p class="text-sm text-gray-400 mb-2">
            جميع الحقوق محفوظة &copy; 2025 | م. حماده أبو رجيلة
        </p>
        <a href="https://wa.me/972569210941" target="_blank" class="text-sm text-gray-300 hover:text-green-400 transition-colors duration-300">
            <i class="bi bi-whatsapp ml-1"></i> تواصل عبر الواتساب
        </a>
    </footer>

    <script>
        (function(){
            // Professional distribution module
            const SAMPLE_BRANCHES = [
                { id: 1, name: 'فرع آل أحمد', families: 12 },
                { id: 2, name: 'فرع آل حامد', families: 8 },
                { id: 3, name: 'فرع آل حمدان', families: 7 },
                { id: 4, name: 'فرع آل حماد', families: 9 }
            ];

            let branches = [];
            let chartInstance = null;

            async function fetchJson(path){
                try{
                    const res = await fetch(path, {cache:'no-store'});
                    if (!res.ok) return null;
                    return await res.json();
                }catch(e){ return null; }
            }

            async function loadBranches(){
                // Priority: window.branchesData -> branches.json (root) -> data/branches.json -> sample
                if (Array.isArray(window.branchesData) && window.branchesData.length){ branches = window.branchesData.map(normalizeBranch); return; }
                const root = await fetchJson('branches.json');
                if (Array.isArray(root) && root.length){ branches = root.map(normalizeBranch); return; }
                const dataFolder = await fetchJson('data/branches.json');
                if (Array.isArray(dataFolder) && dataFolder.length){ branches = dataFolder.map(normalizeBranch); return; }
                branches = SAMPLE_BRANCHES.map(normalizeBranch);
            }

            function normalizeBranch(b){
                return {
                    id: b.id ?? (Math.random()*1e9|0),
                    name: String(b.name || b.branch || 'غير معروف'),
                    families: Number(b.families || b.households || 0),
                    meta: b
                };
            }

            function createBranchesForm(){
                const container = document.getElementById('branchesContainer');
                container.innerHTML = '';
                branches.forEach((br, idx)=>{
                    const row = document.createElement('div');
                    row.className = 'grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 rounded-lg shadow-sm';
                    row.dataset.branchId = br.id;
                    row.innerHTML = `
                        <div>
                            <label class="block text-sm font-bold text-gray-700">${escapeHtml(br.name)}</label>
                            <div class="text-xs text-gray-500 mt-1">عدد العائلات: ${br.families}</div>
                        </div>
                        <div>
                            <div class="flex items-center">
                                <span class="bg-gray-200 text-gray-600 rounded-r-lg p-2"><i class="bi bi-sliders"></i></span>
                                <input type="number" min="0" step="1" class="modern-input flex-1 p-2 rounded-l-lg border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="عامل التخصيص (اختياري)" data-index="${idx}">
                            </div>
                            <div class="text-xs text-gray-500 mt-1">اتركه فارغاً لاستخدام عدد العائلات</div>
                        </div>
                        <div>
                            <div class="flex items-center">
                                <input type="number" class="modern-input flex-1 p-2 rounded-r-lg border-2 border-gray-300 focus:outline-none" readonly data-index="${idx}">
                                <span class="bg-gray-200 text-gray-600 rounded-l-lg p-2">مساعدة</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(row);
                });
            }

            function escapeHtml(s){ if (s==null) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); }

            // Allocation algorithm using fractional remainders to preserve totals
            function allocate(totalAid, mode){
                const n = branches.length;
                if (n===0) return [];

                // build weights: for 'equal' use 1 for all; for 'proportional' use custom weight || families
                const weightEls = document.querySelectorAll('.branch-weight');
                const weights = branches.map((b, i)=>{
                    const el = weightEls[i];
                    const custom = el && el.value !== '' ? Number(el.value) : null;
                    return mode === 'equal' ? 1 : (custom != null ? Math.max(0, Number(custom)) : Math.max(0, Number(b.families || 0)));
                });

                const totalWeight = weights.reduce((s,x)=>s + (isFinite(x)? x:0), 0);

                // raw shares (float)
                const raw = weights.map(w => totalWeight > 0 ? (totalAid * (w/totalWeight)) : (totalAid / n));
                const floorShares = raw.map(r => Math.floor(r));
                let assigned = floorShares.reduce((s,x)=>s+x,0);
                let remainder = totalAid - assigned;

                // fractional parts for fair distribution
                const fractional = raw.map((r,i)=> ({i, frac: r - Math.floor(r), families: branches[i].families}) );

                // tie-breaker: prefer higher families, then higher fractional
                fractional.sort((a,b)=> {
                    if (b.frac !== a.frac) return b.frac - a.frac;
                    return b.families - a.families;
                });

                const extras = new Array(n).fill(0);
                for (let k=0;k<remainder;k++){
                    extras[fractional[k % fractional.length].i] += 1;
                }

                const results = branches.map((b, i)=>{
                    const share = floorShares[i] + extras[i];
                    return {
                        id: b.id,
                        name: b.name,
                        share: share,
                        percentage: totalAid>0 ? ((share/totalAid)*100).toFixed(1) : '0.0'
                    };
                });

                // final sanity: adjust if rounding drift
                const sum = results.reduce((s,r)=>s + r.share,0);
                if (sum !== totalAid){
                    // fix by adding/subtracting from largest/smallest shares
                    let diff = totalAid - sum;
                    if (diff > 0){ // add to largest fractional order
                        for (let f of fractional){ if (diff<=0) break; results[f.i].share +=1; diff--; }
                    } else if (diff < 0){
                        for (let f of fractional.reverse()){ if (diff>=0) break; if (results[f.i].share>0){ results[f.i].share -=1; diff++; } }
                    }
                }

                return results;
            }

            function renderResults(results){
                const container = document.getElementById('distributionResults');
                const resultInputs = document.querySelectorAll('.branch-result');
                container.innerHTML = '';

                results.forEach((r, i)=>{
                    const row = document.createElement('div');
                    row.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg shadow-sm';
                    row.innerHTML = `<div class="font-bold text-gray-800">${escapeHtml(r.name)}</div><div class="text-end"><span class="bg-blue-600 text-white text-sm px-3 py-1 rounded-full ml-2">${r.share} مساعدة</span><small class="text-gray-500">${r.percentage}%</small></div>`;
                    container.appendChild(row);
                    if (resultInputs[i]) resultInputs[i].value = r.share;
                });

                // add export button
                const tools = document.createElement('div');
                tools.className = 'mt-4 flex gap-2';
                const exportBtn = document.createElement('button');
                exportBtn.className = 'bg-gray-200 text-gray-700 px-4 py-2 rounded-full hover:bg-gray-300 transition-colors duration-200';
                exportBtn.type = 'button';
                exportBtn.innerHTML = '<i class="bi bi-download ml-1"></i>تصدير CSV';
                exportBtn.addEventListener('click', ()=> exportCsv(results));
                tools.appendChild(exportBtn);
                container.appendChild(tools);

                // chart
                updateChart(results);
                document.getElementById('resultsCard').style.display = 'block';
                document.getElementById('resultsCard').scrollIntoView({behavior:'smooth', block:'start'});
            }

            function updateChart(results){
                const ctxEl = document.getElementById('distributionChart');
                if (!ctxEl) return;
                ctxEl.style.height = '300px';
                const labels = results.map(r=>r.name);
                const data = results.map(r=>r.share);

                if (chartInstance){ try{ chartInstance.destroy(); }catch(e){} chartInstance = null; }
                chartInstance = new Chart(ctxEl.getContext('2d'), {
                    type: 'pie',
                    data: { labels, datasets: [{ data, backgroundColor: generatePalette(data.length), borderWidth: 1 }] },
                    options: { responsive:true, maintainAspectRatio:false, plugins: { legend:{ position:'bottom' } } }
                });
            }

            function generatePalette(n){
                const base = ['#3b82f6','#10b981','#f59e0b','#ef4444','#6366f1','#a855f7','#0d9488','#be185d'];
                const out = [];
                for (let i=0;i<n;i++) out.push(base[i % base.length]);
                return out;
            }

            function exportCsv(results){
                const rows = [['الفرع','المساعدة','النسبة (%)']];
                results.forEach(r=> rows.push([r.name, r.share, r.percentage]));
                const csv = rows.map(r => r.map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
                const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `distribution_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
            }

            // init
            document.addEventListener('DOMContentLoaded', async ()=>{
                await loadBranches();
                createBranchesForm();

                const form = document.getElementById('distributionForm');
                const totalAidEl = document.getElementById('totalAid');
                const typeEl = document.getElementById('distributionType');
                const submitBtn = form.querySelector('button[type="submit"]');

                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    const totalAid = Number(totalAidEl.value);
                    const mode = typeEl.value;
                    if (!Number.isFinite(totalAid) || totalAid <= 0){ Toastify({text:'أدخل قيمة صحيحة للمساعدات',duration:2500,backgroundColor:'#ef4444'}).showToast(); return; }

                    submitBtn.disabled = true;
                    setTimeout(()=> submitBtn.disabled = false, 600);

                    const results = allocate(Math.floor(totalAid), mode);
                    renderResults(results);
                    Toastify({text:'تم حساب التوزيع',duration:2000,backgroundColor:'#10b981'}).showToast();
                });
            });

        })();
    </script>
</body>
</html>
