<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุชุณุฌูู ุฅุตุงุจุฉ - ุนุงุฆูุฉ ุฃุจู ุฑุฌููุฉ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh;">
    <header class="text-center py-4">
        <div class="container">
            <img src="logo.webp" alt="ุดุนุงุฑ ุนุงุฆูุฉ ุฃุจู ุฑุฌููุฉ" class="mb-3" style="width:80px;height:80px;" />
            <h1 class="h3 mb-2">ุนุงุฆูุฉ ุฃุจู ุฑุฌููุฉ</h1>
            <p class="text-muted">ุชุณุฌูู ุงูุฅุตุงุจุงุช ูุงูุงุญุชูุงุฌุงุช ุงูุทุจูุฉ</p>
        </div>
    </header>

    <main class="container" style="max-width:800px;">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card shadow-lg" style="border-radius:15px; border:none;">
                    <div class="card-header text-center" style="background: linear-gradient(135deg, #0d6efd 0%, #6f42c1 100%); color: white; border-radius: 15px 15px 0 0;">
                        <h2 class="mb-0">๐ฉน ุชุณุฌูู ุฅุตุงุจุฉ ุฌุฏูุฏุฉ</h2>
                        <p class="mb-0 mt-2 opacity-75">ุงููุฃ ุจูุงูุงุช ุงูุฅุตุงุจุฉ ูุชุณุฌูููุง ูู ุณุฌูุงุช ุงูุนุงุฆูุฉ (ุดูุช: ุฅุตุงุจุงุช)</p>
                    </div>
                    <div class="card-body p-4">
                        <form id="injuryForm" class="needs-validation" novalidate>
                            <div class="mb-4">
                                <label for="injuredID" class="form-label fw-bold">ุฑูู ูููุฉ ุงููุตุงุจ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" id="injuredID" pattern="[0-9]{9}" maxlength="9" required>
                                <div class="invalid-feedback">ูุฑุฌู ุฅุฏุฎุงู ุฑูู ูููุฉ ุตุงูุญ (9 ุฃุฑูุงู).</div>
                                <div id="injuredName" class="form-text mt-2 text-success"></div>
                            </div>

                            <div class="mb-4" id="fatherIdSection" style="display:none;">
                                <label for="fatherID" class="form-label fw-bold">ุฑูู ูููุฉ ููู ุงูุฃูุฑ (ุฅู ูุฌุฏ)</label>
                                <input type="text" class="form-control form-control-lg" id="fatherID" pattern="[0-9]{9}" maxlength="9">
                                <div id="fatherName" class="form-text mt-2 text-info"></div>
                            </div>

                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label for="injuryDate" class="form-label fw-bold">ุชุงุฑูุฎ ุงูุฅุตุงุจุฉ <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control form-control-lg" id="injuryDate" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="injuryPlace" class="form-label fw-bold">ููุงู ุงูุฅุตุงุจุฉ <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control form-control-lg" id="injuryPlace" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="injuryCause" class="form-label fw-bold">ุณุจุจ ุงูุฅุตุงุจุฉ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control form-control-lg" id="injuryCause" required>
                            </div>

                            <div class="mb-3">
                                <label for="additionalDetails" class="form-label fw-bold">ุชูุงุตูู ุฅุถุงููุฉ</label>
                                <textarea id="additionalDetails" class="form-control form-control-lg" rows="3"></textarea>
                            </div>

                            <div class="mb-4">
                                <label for="injuryFile" class="form-label fw-bold">ุฑูุน ุชูุฑูุฑ ุทุจู ุฃู ุตูุฑุฉ (ุงุฎุชูุงุฑู)</label>
                                <input type="file" id="injuryFile" class="form-control form-control-lg" accept="image/*,.pdf">
                                <div id="filePreviewContainer" class="mt-2" style="display:none;"><img id="filePreview" src="" alt="ูุนุงููุฉ" class="img-fluid" style="max-height:220px; border-radius:8px;"/></div>
                            </div>

                            <div class="text-end">
                                <button type="submit" class="btn btn-primary btn-lg">ุญูุธ ูุฅุตุงุจุฉ</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer mt-4 text-center">
        <div id="server-status" class="status-indicator mb-2">
            <span class="status-dot"></span>
            <span class="status-text">ุฌุงุฑู ุงูุชุญูู ูู ุญุงูุฉ ุงูุฎุงุฏู...</span>
        </div>
        <p class="copyright-text mb-2">ุฌููุน ุงูุญููู ูุญููุธุฉ ยฉ 2025 | ู. ุญูุงุฏู ุฃุจู ุฑุฌููุฉ</p>
        <a href="https://wa.me/972569210941" target="_blank" class="whatsapp-link"><i class="bi bi-whatsapp"></i> ุชูุงุตู ุนุจุฑ ุงููุงุชุณุงุจ</a>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="script.js"></script>

    <script>
        // Ensure a compatible postToServer exists
        if (typeof postToServer === 'undefined' && window.App && typeof window.App.postToServer === 'function') {
            window.postToServer = function(payload) { return window.App.postToServer(payload); };
        }

        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('injuryForm');
            const injuredID = document.getElementById('injuredID');
            const injuredName = document.getElementById('injuredName');
            const fatherID = document.getElementById('fatherID');
            const fatherName = document.getElementById('fatherName');
            const fatherIdSection = document.getElementById('fatherIdSection');
            const injuryFile = document.getElementById('injuryFile');
            const filePreview = document.getElementById('filePreview');
            const filePreviewContainer = document.getElementById('filePreviewContainer');

            // Verify injured ID and autofill name
            injuredID.addEventListener('input', function(e) {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
            injuredID.addEventListener('blur', async function() {
                const id = this.value.trim();
                if (id.length === 9 && window.App && App.verifyPersonById) {
                    const res = await App.verifyPersonById(id);
                    if (res.exists) { injuredName.textContent = 'ุงูุงุณู: ' + (res.name || ''); fatherIdSection.style.display = 'none'; }
                    else { injuredName.textContent = ''; fatherIdSection.style.display = 'block'; }
                }
            });

            // Father ID check
            fatherID.addEventListener('input', function(e) { this.value = this.value.replace(/[^0-9]/g, ''); });
            fatherID.addEventListener('blur', async function() {
                const id = this.value.trim();
                if (id.length === 9 && typeof postToServer === 'function') {
                    try {
                        const res = await postToServer({ action: 'getUserData', userId: id });
                        if (res && res.success && res.data) fatherName.textContent = 'ุงูุงุณู: ' + (res.data['ุงูุงุณู ุงููุงูู'] || '');
                        else fatherName.textContent = '';
                    } catch (err) { fatherName.textContent = ''; }
                } else fatherName.textContent = '';
            });

            // File preview
            injuryFile.addEventListener('change', function(e) {
                const file = this.files[0];
                if (file && file.type.startsWith('image')) {
                    const reader = new FileReader();
                    reader.onload = function(ev) { filePreview.src = ev.target.result; filePreviewContainer.style.display = 'block'; };
                    reader.readAsDataURL(file);
                } else { filePreviewContainer.style.display = 'none'; }
            });

            const toBase64 = (file) => new Promise((resolve, reject) => {
                if (!file) return resolve(null);
                const reader = new FileReader();
                reader.onload = () => { const base64 = reader.result.substring(reader.result.indexOf(',') + 1); resolve({ name: file.name, mimeType: file.type, data: base64 }); };
                reader.onerror = reject; reader.readAsDataURL(file);
            });

            form.addEventListener('submit', function(e) {
                e.preventDefault();
                if (!form.checkValidity()) { form.classList.add('was-validated'); return; }
                const submitBtn = this.querySelector('button[type="submit"]');
                const origText = submitBtn.textContent;
                submitBtn.disabled = true; submitBtn.textContent = 'ุฌุงุฑู ุงูุญูุธ...';

                (async () => {
                    try {
                        const fileObj = await toBase64(injuryFile.files[0]);
                        const payload = {
                            action: 'submitInjuryRegistration',
                            injuredID: injuredID.value.trim(),
                            fatherID: fatherID.value.trim() || null,
                            injuryDate: document.getElementById('injuryDate').value,
                            injuryPlace: document.getElementById('injuryPlace').value.trim(),
                            injuryCause: document.getElementById('injuryCause').value.trim(),
                            additionalDetails: document.getElementById('additionalDetails').value.trim(),
                            injuryFile: fileObj
                        };

                        const res = await postToServer ? await postToServer(payload) : await App.postToServer(payload);
                        if (!res || !res.success) throw new Error(res?.message || 'ูุดู ุงูุญูุธ');

                        if (window.App && App.showDialog) {
                            App.showDialog({ type: 'success', title: 'ุชู ุงูุญูุธ', message: res.message || 'ุชู ุชุณุฌูู ุงูุฅุตุงุจุฉ ุจูุฌุงุญ', confirmText: 'ุญุณูุงู' });
                        } else if (window.App && App.showToast) {
                            App.showToast(res.message || 'ุชู ุชุณุฌูู ุงูุฅุตุงุจุฉ ุจูุฌุงุญ', true);
                        } else alert(res.message || 'ุชูุช ุงูุฅุถุงูุฉ');

                        form.reset(); filePreviewContainer.style.display = 'none'; injuredName.textContent = ''; fatherName.textContent = '';
                        form.classList.remove('was-validated');
                    } catch (err) {
                        if (window.App && App.showDialog) App.showDialog({ type: 'danger', title: 'ูุดู ุงูุญูุธ', message: err.message || 'ุญุฏุซ ุฎุทุฃ', confirmText: 'ููุงูู' });
                        else if (window.App && App.showToast) App.showToast(err.message || 'ูุดู ุงูุฅุฑุณุงู', false);
                        else alert(err.message || 'ูุดู ุงูุฅุฑุณุงู');
                    } finally { submitBtn.disabled = false; submitBtn.textContent = origText; }
                })();
            });
        });
    </script>
</body>
</html>
