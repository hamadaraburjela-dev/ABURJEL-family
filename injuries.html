<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل إصابة - عائلة أبو رجيلة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: 100vh;">
    <header class="text-center py-4">
        <div class="container">
            <img src="logo.webp" alt="شعار عائلة أبو رجيلة" class="mb-3 logo" style="width:80px;height:80px;border-radius:12px;" />
            <h1 class="h3 mt-2">تسجيل إصابة</h1>
            <p class="text-muted">املأ بيانات الإصابة ليتم إرسال البلاغ إلى إدارة العائلة</p>

            <!-- Service description card -->
            <div class="card mx-auto my-3" style="max-width:920px; background: linear-gradient(90deg, rgba(0,128,0,0.03), rgba(13,110,253,0.02)); border:1px solid rgba(0,0,0,0.06);">
                <div class="card-body text-start" dir="rtl">
                    <h5 class="card-title"><i class="bi bi-bandaid-fill me-2"></i>عن خدمة تسجيل الإصابات</h5>
                    <p class="card-text mb-1">خدمة استقبال بلاغات الإصابات داخل العائلة، تهدف لتوصيل حالة المصاب للفريق الإداري والطبي بسرعة وتنظيم المتابعة.</p>
                    <ul class="small mb-0">
                        <li>أرسل اسم المصاب، رقم الهوية، مكان وتاريخ الإصابة، وسببها إن أمكن.</li>
                        <li>أرفق صورة أو تقرير طبي لسرعة التقييم.</li>
                        <li>الفريق يراجع البلاغ عادة خلال 24 ساعة ويتواصل مع جهات الدعم عند الحاجة.</li>
                        <li>البيانات تعامل بسرية ولا تُنشر دون موافقة المعني.</li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <main class="container" style="max-width:800px;">
                    <div class="row justify-content-center">
                        <div class="col-12">
                            <div class="card shadow-lg" style="border-radius:15px;border:none;">
                                <div class="card-header text-center d-flex flex-column align-items-center">
                                    <h2 class="mb-0"><i class="bi bi-bandaid-fill me-2"></i>بلاغ إصابة جديد</h2>
                                    <p class="mb-0 mt-2 opacity-75">ادخل معلومات المصاب وتفاصيل الإصابة لعرضها على الفريق الإداري</p>
                                </div>
                                <div class="card-body p-4">
                                    <form id="injuryForm" class="needs-validation" novalidate>
                                        <div class="mb-4">
                                            <label for="injuredID" class="form-label fw-bold">رقم الهوية <span class="text-danger">*</span></label>
                                            <input id="injuredID" type="text" class="form-control form-control-lg" pattern="[0-9]{9}" maxlength="9" required placeholder="أدخل رقم الهوية (9 أرقام)">
                                            <div class="invalid-feedback">يرجى إدخال رقم هوية صالح (9 أرقام)</div>
                                            <div id="injuredNote" class="form-text mt-2"></div>
                                        </div>

                                        <div class="mb-4">
                                            <label for="injuredName" class="form-label fw-bold">اسم المصاب <span class="text-danger">*</span></label>
                                            <input id="injuredName" type="text" class="form-control form-control-lg" required placeholder="الاسم الكامل للمصاب">
                                            <div class="invalid-feedback">يرجى إدخال اسم المصاب</div>
                                        </div>

                                        <div class="row g-3 mb-3">
                                            <div class="col-md-6">
                                                <label for="injuryDate" class="form-label fw-bold">تاريخ الإصابة <span class="text-danger">*</span></label>
                                                <input id="injuryDate" type="date" class="form-control form-control-lg" required>
                                                <div class="invalid-feedback">يرجى إدخال تاريخ الإصابة</div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="injuryPlace" class="form-label fw-bold">مكان الإصابة <span class="text-danger">*</span></label>
                                                <input id="injuryPlace" type="text" class="form-control form-control-lg" required placeholder="مكان الإصابة">
                                                <div class="invalid-feedback">يرجى إدخال مكان الإصابة</div>
                                            </div>
                                        </div>

                                        <div class="mb-4">
                                            <label for="injuryCause" class="form-label fw-bold">سبب الإصابة <span class="text-danger">*</span></label>
                                            <input id="injuryCause" type="text" class="form-control form-control-lg" required placeholder="سبب الإصابة">
                                            <div class="invalid-feedback">يرجى ذكر سبب الإصابة</div>
                                        </div>

                                        <div class="mb-4">
                                            <label for="additionalDetails" class="form-label fw-bold">تفاصيل إضافية</label>
                                            <textarea id="additionalDetails" class="form-control form-control-lg" rows="3" placeholder="أكتب أي تفاصيل إضافية عن الحالة أو المطلوب"></textarea>
                                        </div>

                                        <div class="mb-4">
                                            <label for="injuryFile" class="form-label fw-bold">مرفق (صورة أو تقرير طبي)</label>
                                            <input id="injuryFile" type="file" class="form-control form-control-lg" accept="image/*,.pdf">
                                            <div id="filePreview" class="mt-3" style="display:none;"><img id="previewImg" src="" alt="معاينة" class="img-fluid rounded" style="max-height:260px;"/></div>
                                        </div>

                                        <div class="row g-3 mt-4">
                                            <div class="col-md-6">
                                                <button type="button" class="btn btn-outline-secondary btn-lg w-100" onclick="window.location.href='wounded-form.html'">
                                                    <i class="bi bi-grid-3x3-gap-fill me-2"></i>عودة للنماذج
                                                </button>
                                            </div>
                                            <div class="col-md-6">
                                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                                    <i class="bi bi-send-fill me-2"></i>إرسال البلاغ
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>

                <footer class="footer text-center mt-4">
                    <div id="server-status" class="status-indicator mb-2"><span class="status-dot"></span> <span class="status-text">جارِ التحقق من حالة الخادم...</span></div>
                    <p class="text-muted">© 2025 عائلة أبو رجيلى</p>
                </footer>

                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
                <script>
                    document.addEventListener('DOMContentLoaded', function(){
                        const form = document.getElementById('injuryForm');
                        const injuryFile = document.getElementById('injuryFile');
                        const previewImg = document.getElementById('previewImg');
                        const filePreview = document.getElementById('filePreview');

                        injuryFile.addEventListener('change', function(e){
                            const f = e.target.files[0];
                            if(f && f.type.startsWith('image')){
                                const r = new FileReader(); r.onload = (ev)=>{ previewImg.src = ev.target.result; filePreview.style.display='block'; };
                                r.readAsDataURL(f);
                            } else { filePreview.style.display='none'; }
                        });

                        const toBase64 = (file) => new Promise((resolve, reject)=>{
                            if(!file) return resolve(null);
                            const reader = new FileReader(); reader.onload = ()=>{ const raw = reader.result; resolve({ name: file.name, mimeType: file.type, data: raw.substring(raw.indexOf(',')+1) }); };
                            reader.onerror = reject; reader.readAsDataURL(file);
                        });

                        form.addEventListener('submit', function(e){
                            e.preventDefault();
                            if (!form.checkValidity()){ form.classList.add('was-validated'); return; }

                            (async ()=>{
                                const submitBtn = form.querySelector('button[type="submit"]');
                                const orig = submitBtn.textContent; submitBtn.disabled = true; submitBtn.textContent = 'جارٍ الإرسال...';
                                try{
                                    const fileObj = await toBase64(injuryFile.files[0]);
                                    const payload = {
                                        action: 'submitInjuryRegistration',
                                        injuredID: document.getElementById('injuredID').value.trim(),
                                        injuredName: document.getElementById('injuredName').value.trim(),
                                        injuryDate: document.getElementById('injuryDate').value,
                                        injuryPlace: document.getElementById('injuryPlace').value.trim(),
                                        injuryCause: document.getElementById('injuryCause').value.trim(),
                                        additionalDetails: document.getElementById('additionalDetails').value.trim(),
                                        injuryFile: fileObj
                                    };

                                    // use App.postToAPI when available
                                    const res = window.App && App.postToAPI ? await App.postToAPI(payload, true) : await fetch(App.WEB_APP_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload) }).then(r=>r.json());
                                    if (!res || !res.success) throw new Error(res?.message || 'فشل الإرسال');
                                    if (window.App && App.showDialog) App.showDialog({ type: 'success', title: 'تم الإرسال', message: res.message || 'تم إرسال البلاغ بنجاح', confirmText: 'حسناً' });
                                    form.reset(); filePreview.style.display='none'; form.classList.remove('was-validated');
                                }catch(err){
                                    if (window.App && App.showToast) App.showToast(err.message || 'خطأ في الإرسال', false); else alert(err.message||'خطأ');
                                }finally{ submitBtn.disabled = false; submitBtn.textContent = orig; }
                            })();
                        });
                    });
                </script>

</body>
</html>
