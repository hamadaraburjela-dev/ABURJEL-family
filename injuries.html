<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل إصابة - عائلة أبو رجيلة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        * { font-family: 'Cairo', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .main-content { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius:20px; padding:30px; margin:20px auto; border:1px solid rgba(255,255,255,0.2); max-width:700px }
        .form-label { font-weight:500; }
        .form-section { background:rgba(255,255,255,0.95); border-radius:16px; padding:24px; box-shadow:0 8px 32px rgba(0,0,0,0.08); }
        .preview-img { max-width:120px; max-height:120px; border-radius:10px; margin-top:10px; }
    </style>
</head>
<body>
    <div class="container">
        <main class="main-content">
            <h3 class="mb-4 text-center text-primary">تسجيل إصابة جديدة</h3>
            <form id="injuryForm">
                <div class="form-section mb-3">
                    <label class="form-label">رقم هوية المصاب</label>
                    <input type="text" class="form-control" id="injuredID" maxlength="9" required>
                    <div id="injuredName" class="mt-2 text-success"></div>
                </div>
                <div class="form-section mb-3" id="fatherSection" style="display:none">
                    <label class="form-label">رقم هوية ولي الأمر (إذا المصاب طفل أو غير موجود في قاعدة البيانات)</label>
                    <input type="text" class="form-control" id="fatherID" maxlength="9">
                    <div id="fatherName" class="mt-2 text-info"></div>
                </div>
                <div class="form-section mb-3">
                    <label class="form-label">تاريخ الإصابة</label>
                    <input type="date" class="form-control" id="injuryDate" required>
                </div>
                <div class="form-section mb-3">
                    <label class="form-label">مكان الإصابة</label>
                    <input type="text" class="form-control" id="injuryPlace" required>
                </div>
                <div class="form-section mb-3">
                    <label class="form-label">سبب الإصابة</label>
                    <input type="text" class="form-control" id="injuryCause" required>
                </div>
                <div class="form-section mb-3">
                    <label class="form-label">تفاصيل إضافية</label>
                    <textarea class="form-control" id="additionalDetails" rows="2"></textarea>
                </div>
                <div class="form-section mb-3">
                    <label class="form-label">رفع تقرير طبي أو صورة الإصابة</label>
                    <input type="file" class="form-control" id="injuryFile" accept="image/*,application/pdf">
                    <img id="filePreview" class="preview-img" style="display:none">
                </div>
                <button type="submit" class="btn btn-primary w-100">تسجيل الإصابة</button>
            </form>
        </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="script.js"></script>
    <script>
        // تحقق من رقم الهوية
        document.getElementById('injuredID').addEventListener('blur', async function() {
            const id = this.value.trim();
            if (id.length === 9 && window.App && App.verifyPersonById) {
                const res = await App.verifyPersonById(id);
                if (res.exists) {
                    document.getElementById('injuredName').textContent = 'الاسم: ' + res.name;
                    document.getElementById('fatherSection').style.display = 'none';
                } else {
                    document.getElementById('injuredName').textContent = '';
                    document.getElementById('fatherSection').style.display = 'block';
                }
            }
        });
        // تحقق من ولي الأمر
        document.getElementById('fatherID').addEventListener('blur', async function() {
            const id = this.value.trim();
            if (id.length === 9 && window.App && App.verifyPersonById) {
                const res = await App.verifyPersonById(id);
                document.getElementById('fatherName').textContent = res.exists ? 'الاسم: ' + res.name : '';
            }
        });
        // معاينة الملف
        document.getElementById('injuryFile').addEventListener('change', function() {
            const file = this.files[0];
            const preview = document.getElementById('filePreview');
            if (file && file.type.startsWith('image')) {
                const reader = new FileReader();
                reader.onload = e => { preview.src = e.target.result; preview.style.display = 'block'; };
                reader.readAsDataURL(file);
            } else { preview.style.display = 'none'; }
        });
        // إرسال النموذج
        document.getElementById('injuryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const injuredID = document.getElementById('injuredID').value.trim();
            const fatherID = document.getElementById('fatherID').value.trim();
            const injuryDate = document.getElementById('injuryDate').value;
            const injuryPlace = document.getElementById('injuryPlace').value.trim();
            const injuryCause = document.getElementById('injuryCause').value.trim();
            const additionalDetails = document.getElementById('additionalDetails').value.trim();
            const fileInput = document.getElementById('injuryFile');
            let injuryFile = null;
            if (fileInput.files[0]) {
                const file = fileInput.files[0];
                injuryFile = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve({ name: file.name, mimeType: file.type, data: base64 });
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }
            // إرسال البيانات
            try {
                const payload = {
                    action: 'submitInjuryRegistration',
                    injuredID,
                    injuryDate,
                    injuryPlace,
                    injuryCause,
                    additionalDetails,
                    fatherID,
                    injuryFile
                };
                const res = await App.postToServer(payload);
                if (res && res.success) {
                    App.showToast(res.message || 'تم تسجيل الإصابة بنجاح', true);
                    this.reset();
                    document.getElementById('filePreview').style.display = 'none';
                    document.getElementById('injuredName').textContent = '';
                    document.getElementById('fatherName').textContent = '';
                } else {
                    App.showToast(res.message || 'فشل التسجيل', false);
                }
            } catch (err) {
                App.showToast(err.message || 'حدث خطأ أثناء التسجيل', false);
            }
        });
    </script>
</body>
</html>
