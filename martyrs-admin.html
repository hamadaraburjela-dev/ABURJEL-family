<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الشهداء - عائلة أبو رجيلة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .container-fluid {
            max-width: 1600px;
            margin: 0 auto;
            padding: 15px 15px 0 15px;
        }

        .header {
            max-width: 1400px;
            margin: 0 auto;
            width: calc(100% - 30px);
            margin-top: 0;
            margin-bottom: 20px;
        }

        /* تحسينات للأجهزة الصغيرة */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 10px 10px 0 10px;
            }
            
            .main-content {
                width: calc(100% - 20px);
                margin: 10px auto;
                padding: 20px;
            }
            
            .header {
                width: calc(100% - 20px);
                margin: 0 auto 15px auto;
            }
            
            .stats-card {
                margin-bottom: 15px;
            }
        }
        
        .main-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 1400px;
            width: calc(100% - 30px);
        }
        
        .stats-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            border: none;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4);
            animation: shimmer 3s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .stats-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .stats-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 2rem;
            position: relative;
            overflow: hidden;
        }
        
        .stats-icon.danger {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            color: white;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .stats-icon.warning {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: white;
        }
        
        .stats-icon.success {
            background: linear-gradient(135deg, #66bb6a, #4caf50);
            color: white;
        }
        
        .stats-icon.info {
            background: linear-gradient(135deg, #42a5f5, #2196f3);
            color: white;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .data-table-card {
            background: rgba(255, 255, 255, 0.95);
            border: none;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            width: 100%;
        }
        
        .card-header-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 30px;
        }
        
        .action-buttons .btn {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 500;
            margin: 0 5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-buttons .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .action-buttons .btn:hover::before {
            left: 100%;
        }
        
        .search-filters {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .form-control {
            border-radius: 15px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            padding: 12px 20px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .table-modern {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .table-modern thead th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
        }
        
        .table-modern tbody tr {
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .table-modern tbody tr:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
            text-align: center;
            min-width: 100px;
            display: inline-block;
        }
        
        .status-new {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }
        
        .status-pending {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }
        
        .status-approved {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }
        
        .status-rejected {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .loading-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 50px;
            text-align: center;
        }
        
        .spinner-modern {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(102, 126, 234, 0.3);
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            padding: 60px;
            text-align: center;
        }
        
        .modal-modern .modal-content {
            border: none;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }
        
        .modal-modern .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 30px;
        }
        
        .btn-modern {
            border-radius: 25px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.3s;
        }
        
        .btn-modern:hover::before {
            left: 100%;
        }

        /* تحسينات إضافية */
        .logo-container {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        .table-row-hover:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        /* تأثير الكتابة للعنوان */
        .header-title {
            background: linear-gradient(45deg, #fff, #f0f0f0, #fff);
            background-size: 200% 200%;
            animation: textShine 3s ease-in-out infinite;
            -webkit-background-clip: text;
            background-clip: text;
        }

        @keyframes textShine {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* تأثير الدخول للكروت */
        .stats-card {
            animation: fadeInUp 0.6s ease-out;
        }

        .col-md-3:nth-child(1) .stats-card { animation-delay: 0.1s; }
        .col-md-3:nth-child(2) .stats-card { animation-delay: 0.2s; }
        .col-md-3:nth-child(3) .stats-card { animation-delay: 0.3s; }
        .col-md-3:nth-child(4) .stats-card { animation-delay: 0.4s; }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(30px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* تأثير الجدول */
        .data-table-card {
            animation: slideInUp 0.8s ease-out 0.5s both;
        }

        @keyframes slideInUp {
            0% {
                opacity: 0;
                transform: translateY(50px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* تحسينات الأزرار */
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* تأثير النبضة للإشعارات */
        .stats-icon.danger::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 2px solid #ff6b6b;
            animation: ripple 2s ease-out infinite;
        }

        @keyframes ripple {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <header class="header position-relative overflow-hidden">
            <div class="position-absolute top-0 start-0 w-100 h-100" style="background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%); backdrop-filter: blur(10px);"></div>
            <div class="d-flex align-items-center position-relative">
                <div class="logo-container me-3">
                    <img src="logo.webp" alt="شعار" class="header-logo rounded-circle shadow-sm" style="border: 3px solid rgba(255,255,255,0.3);">
                </div>
                <div>
                    <h1 class="header-title d-none d-sm-inline-block align-middle mb-0 text-white fw-700">إدارة الشهداء</h1>
                    <p class="text-white-50 mb-0 small d-none d-md-block">نظام إدارة طلبات تسجيل الشهداء</p>
                </div>
            </div>
            <div class="d-flex align-items-center position-relative">
                <button class="btn btn-outline-light btn-modern me-2" onclick="location.href='admin.html'">
                    <i class="bi bi-arrow-left me-1"></i>العودة للوحة التحكم
                </button>
                <button class="btn btn-danger btn-modern" onclick="sessionStorage.clear(); localStorage.clear(); location.href='index.html'">
                    <i class="bi bi-box-arrow-right me-1"></i>تسجيل الخروج
                </button>
            </div>
        </header>

        <main class="main-content">
            <!-- إحصائيات سريعة -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon danger">
                            <i class="bi bi-heart-fill"></i>
                        </div>
                        <h3 class="fw-bold mb-1" id="totalMartyrs">0</h3>
                        <p class="text-muted mb-0 fw-500">إجمالي الشهداء</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon warning">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <h3 class="fw-bold mb-1" id="pendingRequests">0</h3>
                        <p class="text-muted mb-0 fw-500">طلبات قيد المراجعة</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon success">
                            <i class="bi bi-check-circle-fill"></i>
                        </div>
                        <h3 class="fw-bold mb-1" id="approvedRequests">0</h3>
                        <p class="text-muted mb-0 fw-500">طلبات موافق عليها</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <div class="stats-icon info">
                            <i class="bi bi-calendar-date"></i>
                        </div>
                        <h3 class="fw-bold mb-1" id="thisMonthMartyrs">0</h3>
                        <p class="text-muted mb-0 fw-500">شهداء هذا الشهر</p>
                    </div>
                </div>
            </div>

            <!-- قائمة طلبات الشهداء -->
            <div class="data-table-card">
                <div class="card-header-modern d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-600">
                        <i class="bi bi-list-ul me-2"></i>طلبات تسجيل الشهداء
                    </h5>
                    <div class="action-buttons d-flex">
                        <button class="btn btn-outline-light btn-modern" onclick="refreshRequests()">
                            <i class="bi bi-arrow-clockwise me-1"></i>تحديث
                        </button>
                        <button class="btn btn-success btn-modern" onclick="exportToExcel()">
                            <i class="bi bi-file-earmark-excel me-1"></i>تصدير Excel
                        </button>
                    </div>
                </div>
                <div class="card-body p-4">
                    <!-- فلاتر البحث -->
                    <div class="search-filters">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="position-relative">
                                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                                    <input type="text" class="form-control ps-5" id="searchInput" placeholder="البحث برقم الهوية أو الاسم...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-control" id="statusFilter">
                                    <option value="">جميع الحالات</option>
                                    <option value="جديد">جديد</option>
                                    <option value="قيد المراجعة">قيد المراجعة</option>
                                    <option value="موافق عليه">موافق عليه</option>
                                    <option value="مرفوض">مرفوض</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-control" id="causeFilter">
                                    <option value="">جميع الأسباب</option>
                                    <option value="قصف جوي">قصف جوي</option>
                                    <option value="قصف مدفعي">قصف مدفعي</option>
                                    <option value="رصاص قناص">رصاص قناص</option>
                                    <option value="انفجار قذيفة">انفجار قذيفة</option>
                                    <option value="مرض بسبب الحرب">مرض بسبب الحرب</option>
                                    <option value="نقص في العلاج">نقص في العلاج</option>
                                    <option value="أخرى">أخرى</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary btn-modern w-100" onclick="applyFilters()">
                                    <i class="bi bi-funnel me-1"></i>فلترة
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- جدول الطلبات -->
                    <div class="table-responsive">
                        <table class="table table-modern">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-hash me-2"></i>معرف الطلب</th>
                                    <th><i class="bi bi-calendar me-2"></i>تاريخ التسجيل</th>
                                    <th><i class="bi bi-person me-2"></i>اسم الشهيد</th>
                                    <th><i class="bi bi-card-text me-2"></i>رقم الهوية</th>
                                    <th><i class="bi bi-calendar-x me-2"></i>تاريخ الاستشهاد</th>
                                    <th><i class="bi bi-geo-alt me-2"></i>مكان الاستشهاد</th>
                                    <th><i class="bi bi-exclamation-triangle me-2"></i>سبب الاستشهاد</th>
                                    <th><i class="bi bi-activity me-2"></i>الحالة</th>
                                    <th><i class="bi bi-gear me-2"></i>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="requestsTableBody">
                                <!-- سيتم ملؤها بواسطة JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div id="loadingSpinner" class="loading-container">
                        <div class="spinner-modern mx-auto mb-3"></div>
                        <h5 class="text-primary fw-600">جاري تحميل البيانات...</h5>
                        <p class="text-muted mb-0">يرجى الانتظار لحظات قليلة</p>
                    </div>

                    <div id="noData" class="no-data-container" style="display: none;">
                        <div class="mb-4">
                            <i class="bi bi-inbox-fill display-1 text-muted opacity-50"></i>
                        </div>
                        <h4 class="text-muted fw-600 mb-2">لا توجد طلبات لعرضها</h4>
                        <p class="text-muted mb-0">لم يتم العثور على أي طلبات تسجيل شهداء بالفلاتر المحددة</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal تفاصيل الطلب -->
    <div class="modal fade modal-modern" id="requestDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-600">
                        <i class="bi bi-info-circle me-2"></i>تفاصيل طلب الشهيد
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="requestDetailsBody">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button type="button" class="btn btn-secondary btn-modern" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal تغيير الحالة -->
    <div class="modal fade modal-modern" id="statusUpdateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-600">
                        <i class="bi bi-gear me-2"></i>تغيير حالة الطلب
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label fw-600">الحالة الجديدة:</label>
                        <select class="form-control" id="newStatus">
                            <option value="جديد">جديد</option>
                            <option value="قيد المراجعة">قيد المراجعة</option>
                            <option value="موافق عليه">موافق عليه</option>
                            <option value="مرفوض">مرفوض</option>
                        </select>
                    </div>
                    <input type="hidden" id="currentRequestId">
                </div>
                <div class="modal-footer border-0 px-4 pb-4">
                    <button type="button" class="btn btn-secondary btn-modern" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary btn-modern" onclick="updateStatus()">تحديث الحالة</button>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>

    <script>
        let martyrRequests = [];
        let filteredRequests = [];

        // التحقق من تسجيل الدخول
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking App object:', typeof App);
            console.log('App.isAdminLoggedIn available:', typeof App?.isAdminLoggedIn);
            console.log('App.postToAPI available:', typeof App?.postToAPI);
            
            // التحقق من تسجيل دخول المدير
            const adminToken = sessionStorage.getItem('adminToken');
            if (!adminToken && (!App || !App.isAdminLoggedIn())) {
                console.log('Admin not logged in');
                window.location.href = 'index.html';
                return;
            }
            
            loadMartyrRequests();
        });

        // تحميل طلبات الشهداء
        async function loadMartyrRequests() {
            // إضافة تأثير التحميل
            const loadingElement = document.getElementById('loadingSpinner');
            const tableBody = document.getElementById('requestsTableBody');
            
            // إخفاء الجدول وإظهار شاشة التحميل مع تأثير fade
            if (tableBody) {
                tableBody.style.opacity = '0';
                tableBody.style.transition = 'opacity 0.3s ease';
            }
            
            loadingElement.style.display = 'block';
            loadingElement.style.opacity = '0';
            setTimeout(() => { loadingElement.style.opacity = '1'; }, 100);
            
            try {
                const token = sessionStorage.getItem('adminToken');
                console.log('Loading martyr requests with token:', token ? 'exists' : 'missing');
                
                let response;
                if (App && App.postToAPI) {
                    response = await App.postToAPI({ action: 'getMartyrRequests', token });
                } else {
                    // Fallback direct fetch using shared WEB_APP_URL
                    const res = await fetch(App.WEB_APP_URL, {
                        method: 'POST',
                        mode: 'cors',
                        redirect: 'follow',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({ action: 'getMartyrRequests', token })
                    });
                    const text = await res.text();
                    console.log('Raw response:', text);
                    try {
                        response = JSON.parse(text);
                    } catch (parseError) {
                        console.error('JSON parse error:', parseError, 'Raw text:', text);
                        throw new Error('خطأ في تحليل الاستجابة من الخادم');
                    }
                }
                console.log('Response received:', response);
                
                if (response.success) {
                    martyrRequests = response.data || [];
                    filteredRequests = martyrRequests;
                    console.log('Martyr requests loaded:', martyrRequests.length, 'items');
                    
                    // تأخير بسيط لإظهار التأثير البصري
                    setTimeout(() => {
                        renderRequests();
                        updateStatistics();
                        
                        // إخفاء شاشة التحميل مع تأثير fade وإظهار الجدول
                        loadingElement.style.opacity = '0';
                        setTimeout(() => {
                            loadingElement.style.display = 'none';
                            if (tableBody) {
                                tableBody.style.opacity = '1';
                            }
                        }, 300);
                        
                        // صوت إشعار النجاح (اختياري)
                        try {
                            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFA==');
                            audio.volume = 0.1;
                            audio.play().catch(() => {}); // تجاهل الخطأ إذا لم يُسمح بتشغيل الصوت
                        } catch (e) {
                            // تجاهل أخطاء الصوت
                        }
                    }, 800);
                    
                } else {
                    throw new Error(response.message || 'فشل تحميل البيانات');
                }
            } catch (error) {
                console.error('Error loading martyr requests:', error);
                if (App && App.showToast) {
                    App.showToast('خطأ في تحميل البيانات: ' + error.message, false);
                } else {
                    alert('خطأ في تحميل البيانات: ' + error.message);
                }
                loadingElement.style.opacity = '0';
                setTimeout(() => {
                    loadingElement.style.display = 'none';
                    document.getElementById('noData').style.display = 'block';
                }, 300);
            }
        }

        // عرض الطلبات مع التأثيرات البصرية
        function renderRequests() {
            const tbody = document.getElementById('requestsTableBody');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const noData = document.getElementById('noData');
            
            // تأثير الانتقال للجدول
            tbody.style.transition = 'opacity 0.3s ease';
            tbody.style.opacity = '0';
            
            loadingSpinner.style.display = 'none';
            
            if (!filteredRequests || filteredRequests.length === 0) {
                tbody.innerHTML = '';
                noData.style.display = 'block';
                noData.style.opacity = '0';
                setTimeout(() => {
                    noData.style.opacity = '1';
                    noData.style.transition = 'opacity 0.5s ease';
                }, 100);
                return;
            }
            
            noData.style.display = 'none';
            
            tbody.innerHTML = filteredRequests.map(request => {
                const statusBadge = getStatusBadge(request['حالة الطلب']);
                const martyrdomDate = new Date(request['تاريخ الاستشهاد']).toLocaleDateString('ar-EG');
                const registrationDate = new Date(request['تاريخ التسجيل']).toLocaleDateString('ar-EG');
                
                return `
                    <tr class="table-row-hover">
                        <td>
                            <span class="badge bg-primary rounded-pill">#${request['معرف الطلب']}</span>
                        </td>
                        <td>
                            <i class="bi bi-calendar3 text-muted me-2"></i>
                            <span class="fw-500">${registrationDate}</span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 35px; height: 35px;">
                                    <i class="bi bi-person-fill text-white"></i>
                                </div>
                                <strong class="text-dark">${request['اسم الشهيد']}</strong>
                            </div>
                        </td>
                        <td>
                            <span class="font-monospace bg-light px-2 py-1 rounded">${request['رقم هوية الشهيد']}</span>
                        </td>
                        <td>
                            <i class="bi bi-calendar-x text-danger me-2"></i>
                            <span class="text-danger fw-500">${martyrdomDate}</span>
                        </td>
                        <td>
                            <i class="bi bi-geo-alt text-warning me-2"></i>
                            <span>${request['مكان الاستشهاد']}</span>
                        </td>
                        <td>
                            <span class="badge bg-dark rounded-pill">${request['سبب الاستشهاد']}</span>
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-info btn-modern" onclick="viewDetails('${request['معرف الطلب']}')" title="عرض التفاصيل">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning btn-modern" onclick="openStatusModal('${request['معرف الطلب']}', '${request['حالة الطلب']}')" title="تغيير الحالة">
                                    <i class="bi bi-gear"></i>
                                </button>
                                ${request['رابط شهادة الوفاة'] ? `
                                <button class="btn btn-sm btn-outline-success btn-modern" onclick="window.open('${request['رابط شهادة الوفاة']}', '_blank')" title="عرض شهادة الوفاة">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // تأثير ظهور الجدول
            setTimeout(() => {
                tbody.style.opacity = '1';
                
                // تأثير الظهور التدريجي للصفوف
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, index) => {
                    row.style.opacity = '0';
                    row.style.transform = 'translateX(20px)';
                    row.style.transition = 'all 0.3s ease';
                    
                    setTimeout(() => {
                        row.style.opacity = '1';
                        row.style.transform = 'translateX(0)';
                    }, index * 50); // تأخير تدريجي لكل صف
                });
            }, 100);
        }

        // تحديث الإحصائيات مع تأثيرات بصرية
        function updateStatistics() {
            const total = martyrRequests.length;
            const pending = martyrRequests.filter(r => r['حالة الطلب'] === 'قيد المراجعة').length;
            const approved = martyrRequests.filter(r => r['حالة الطلب'] === 'موافق عليه').length;
            
            const thisMonth = new Date();
            const thisMonthMartyrs = martyrRequests.filter(r => {
                const martyrdomDate = new Date(r['تاريخ الاستشهاد']);
                return martyrdomDate.getMonth() === thisMonth.getMonth() && 
                       martyrdomDate.getFullYear() === thisMonth.getFullYear();
            }).length;

            // تأثير العد التصاعدي للأرقام
            animateCounter('totalMartyrs', total);
            animateCounter('pendingRequests', pending);
            animateCounter('approvedRequests', approved);
            animateCounter('thisMonthMartyrs', thisMonthMartyrs);
        }

        // دالة تأثير العد التصاعدي
        function animateCounter(elementId, targetValue) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const startValue = 0;
            const duration = 1500; // 1.5 ثانية
            const startTime = performance.now();
            
            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // استخدام easeOutCubic للحصول على تأثير طبيعي
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const currentValue = Math.floor(startValue + (targetValue - startValue) * easeProgress);
                
                element.textContent = currentValue.toLocaleString('ar-EG');
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                } else {
                    element.textContent = targetValue.toLocaleString('ar-EG');
                    // تأثير نبضة في النهاية
                    element.style.transform = 'scale(1.1)';
                    setTimeout(() => {
                        element.style.transition = 'transform 0.3s ease';
                        element.style.transform = 'scale(1)';
                    }, 100);
                }
            }
            
            requestAnimationFrame(updateCounter);
            
            document.getElementById('totalMartyrs').textContent = total;
            document.getElementById('pendingRequests').textContent = pending;
            document.getElementById('approvedRequests').textContent = approved;
            document.getElementById('thisMonthMartyrs').textContent = thisMonthMartyrs;
        }

        // عرض تفاصيل الطلب
        function viewDetails(requestId) {
            const request = martyrRequests.find(r => r['معرف الطلب'] === requestId);
            if (!request) return;
            
            const registrationDate = new Date(request['تاريخ التسجيل']).toLocaleDateString('ar-EG');
            const martyrdomDate = new Date(request['تاريخ الاستشهاد']).toLocaleDateString('ar-EG');
            
            const detailsHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-person-fill me-2"></i>بيانات الشهيد</h6>
                        <ul class="list-unstyled">
                            <li><strong>الاسم:</strong> ${request['اسم الشهيد']}</li>
                            <li><strong>رقم الهوية:</strong> ${request['رقم هوية الشهيد']}</li>
                            <li><strong>تاريخ الاستشهاد:</strong> ${martyrdomDate}</li>
                            <li><strong>مكان الاستشهاد:</strong> ${request['مكان الاستشهاد']}</li>
                            <li><strong>سبب الاستشهاد:</strong> ${request['سبب الاستشهاد']}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-info-circle me-2"></i>معلومات الطلب</h6>
                        <ul class="list-unstyled">
                            <li><strong>معرف الطلب:</strong> <code>${request['معرف الطلب']}</code></li>
                            <li><strong>تاريخ التسجيل:</strong> ${registrationDate}</li>
                            <li><strong>الحالة:</strong> <span class="badge ${getStatusClass(request['حالة الطلب'])}">${request['حالة الطلب']}</span></li>
                        </ul>
                    </div>
                </div>
                
                ${request['تفاصيل إضافية'] ? `
                <hr>
                <h6><i class="bi bi-chat-text me-2"></i>تفاصيل إضافية</h6>
                <p class="bg-light p-3 rounded">${request['تفاصيل إضافية']}</p>
                ` : ''}
                
                ${request['رابط شهادة الوفاة'] ? `
                <hr>
                <h6><i class="bi bi-file-earmark-pdf me-2"></i>المرفقات</h6>
                <a href="${request['رابط شهادة الوفاة']}" target="_blank" class="btn btn-outline-success">
                    <i class="bi bi-download me-1"></i>عرض شهادة الوفاة
                </a>
                ` : ''}
            `;
            
            document.getElementById('requestDetailsBody').innerHTML = detailsHtml;
            new bootstrap.Modal(document.getElementById('requestDetailsModal')).show();
        }

        // فتح نافذة تغيير الحالة
        function openStatusModal(requestId, currentStatus) {
            document.getElementById('currentRequestId').value = requestId;
            document.getElementById('newStatus').value = currentStatus;
            new bootstrap.Modal(document.getElementById('statusUpdateModal')).show();
        }

        // تحديث حالة الطلب
        async function updateStatus() {
            try {
                const requestId = document.getElementById('currentRequestId').value;
                const newStatus = document.getElementById('newStatus').value;
                const token = sessionStorage.getItem('adminToken');
                
                let response;
                if (App && App.postToAPI) {
                    response = await App.postToAPI({
                        action: 'updateMartyrRequestStatus',
                        token,
                        requestId,
                        newStatus
                    });
                } else {
                    // Fallback direct fetch using shared WEB_APP_URL
                    const res = await fetch(App.WEB_APP_URL, {
                        method: 'POST',
                        mode: 'cors',
                        redirect: 'follow',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify({
                            action: 'updateMartyrRequestStatus',
                            token,
                            requestId,
                            newStatus
                        })
                    });
                    const text = await res.text();
                    response = JSON.parse(text);
                }
                
                if (response.success) {
                    if (App && App.showToast) {
                        App.showToast('تم تحديث حالة الطلب بنجاح', true);
                    } else {
                        alert('تم تحديث حالة الطلب بنجاح');
                    }
                    bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal')).hide();
                    await loadMartyrRequests();
                } else {
                    throw new Error(response.message || 'فشل تحديث الحالة');
                }
            } catch (error) {
                if (App && App.showToast) {
                    App.showToast('خطأ في تحديث الحالة: ' + error.message, false);
                } else {
                    alert('خطأ في تحديث الحالة: ' + error.message);
                }
            }
        }

        // تطبيق الفلاتر مع تسليط الضوء على النتائج
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const causeFilter = document.getElementById('causeFilter').value;
            
            // إضافة تأثير بصري للبحث
            const searchInput = document.getElementById('searchInput');
            if (searchTerm) {
                searchInput.style.borderColor = '#667eea';
                searchInput.style.boxShadow = '0 0 0 0.2rem rgba(102, 126, 234, 0.25)';
            } else {
                searchInput.style.borderColor = '';
                searchInput.style.boxShadow = '';
            }
            
            filteredRequests = martyrRequests.filter(request => {
                const matchesSearch = !searchTerm || 
                    request['اسم الشهيد'].toLowerCase().includes(searchTerm) ||
                    request['رقم هوية الشهيد'].includes(searchTerm);
                    
                const matchesStatus = !statusFilter || request['حالة الطلب'] === statusFilter;
                const matchesCause = !causeFilter || request['سبب الاستشهاد'] === causeFilter;
                
                return matchesSearch && matchesStatus && matchesCause;
            });
            
            // صوت عند إيجاد نتائج
            if (filteredRequests.length > 0 && searchTerm) {
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCjiR1/LNeSsFJHfH8N2QQAoUXrTp66hVFA==');
                    audio.volume = 0.05;
                    audio.play().catch(() => {});
                } catch (e) {}
            }
            
            renderRequests();
        }

        // تحديث البيانات
        function refreshRequests() {
            loadMartyrRequests();
        }

        // تصدير إلى Excel
        function exportToExcel() {
            if (!filteredRequests.length) {
                if (App && App.showToast) {
                    App.showToast('لا توجد بيانات للتصدير', false);
                } else {
                    alert('لا توجد بيانات للتصدير');
                }
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(filteredRequests);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "الشهداء");
            XLSX.writeFile(wb, `شهداء-عائلة-أبو-رجيلة-${new Date().toLocaleDateString('ar-EG')}.xlsx`);
            if (App && App.showToast) {
                App.showToast('تم تصدير البيانات بنجاح', true);
            } else {
                alert('تم تصدير البيانات بنجاح');
            }
        }

        // الحصول على class الحالة
        function getStatusClass(status) {
            switch (status) {
                case 'جديد': return 'bg-primary';
                case 'قيد المراجعة': return 'bg-warning';
                case 'موافق عليه': return 'bg-success';
                case 'مرفوض': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // الحصول على badge الحالة مع التصميم الجديد
        function getStatusBadge(status) {
            switch (status) {
                case 'جديد': 
                    return '<span class="status-badge status-new"><i class="bi bi-star me-1"></i>جديد</span>';
                case 'قيد المراجعة': 
                    return '<span class="status-badge status-pending"><i class="bi bi-clock me-1"></i>قيد المراجعة</span>';
                case 'موافق عليه': 
                    return '<span class="status-badge status-approved"><i class="bi bi-check-circle me-1"></i>موافق عليه</span>';
                case 'مرفوض': 
                    return '<span class="status-badge status-rejected"><i class="bi bi-x-circle me-1"></i>مرفوض</span>';
                default: 
                    return '<span class="status-badge bg-secondary"><i class="bi bi-question-circle me-1"></i>غير محدد</span>';
            }
        }

        // البحث أثناء الكتابة مع تأخير لتحسين الأداء
        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 300);
        });
        
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('causeFilter').addEventListener('change', applyFilters);

        // إضافة shortcuts للوحة المفاتيح
        document.addEventListener('keydown', function(e) {
            // Ctrl + F للبحث
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('searchInput').focus();
            }
            
            // Ctrl + R لتحديث البيانات
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshRequests();
            }
            
            // Escape لإلغاء البحث
            if (e.key === 'Escape') {
                const searchInput = document.getElementById('searchInput');
                if (searchInput.value) {
                    searchInput.value = '';
                    applyFilters();
                }
            }
        });

        // إضافة tooltip للأزرار
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // تحسين تجربة المستخدم عند التحميل
        window.addEventListener('load', function() {
            // إضافة تأثير fade-in للصفحة
            document.body.style.opacity = '0';
            document.body.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                document.body.style.opacity = '1';
            }, 100);
            
            // رسالة ترحيب
            setTimeout(() => {
                if (App && App.showToast) {
                    App.showToast('مرحباً بك في لوحة إدارة الشهداء 🌹', true);
                }
            }, 1000);
        });
    </script>
</body>
</html>
