<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة الشهداء - عائلة أبو رجيلة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <header class="header">
            <div class="d-flex align-items-center">
                <img src="logo.webp" alt="شعار" class="header-logo">
                <h1 class="header-title d-none d-sm-inline-block align-middle ms-3">إدارة الشهداء</h1>
            </div>
            <div class="d-flex align-items-center">
                <a href="admin.html" class="btn btn-outline-secondary me-2">العودة للوحة التحكم</a>
                <a href="index.html" onclick="sessionStorage.clear(); localStorage.clear();" class="btn btn-outline-danger">تسجيل الخروج</a>
            </div>
        </header>

        <main class="main-content">
            <!-- إحصائيات سريعة -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-heart-fill text-danger mb-2" style="font-size: 2rem;"></i>
                            <h4 class="fw-bold" id="totalMartyrs">0</h4>
                            <p class="text-muted mb-0">إجمالي الشهداء</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-clock-history text-warning mb-2" style="font-size: 2rem;"></i>
                            <h4 class="fw-bold" id="pendingRequests">0</h4>
                            <p class="text-muted mb-0">طلبات قيد المراجعة</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-check-circle-fill text-success mb-2" style="font-size: 2rem;"></i>
                            <h4 class="fw-bold" id="approvedRequests">0</h4>
                            <p class="text-muted mb-0">طلبات موافق عليها</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="bi bi-calendar-date text-info mb-2" style="font-size: 2rem;"></i>
                            <h4 class="fw-bold" id="thisMonthMartyrs">0</h4>
                            <p class="text-muted mb-0">شهداء هذا الشهر</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- قائمة طلبات الشهداء -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>طلبات تسجيل الشهداء
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshRequests()">
                            <i class="bi bi-arrow-clockwise me-1"></i>تحديث
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportToExcel()">
                            <i class="bi bi-file-earmark-excel me-1"></i>تصدير Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- فلاتر البحث -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="البحث برقم الهوية أو الاسم...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="statusFilter">
                                <option value="">جميع الحالات</option>
                                <option value="جديد">جديد</option>
                                <option value="قيد المراجعة">قيد المراجعة</option>
                                <option value="موافق عليه">موافق عليه</option>
                                <option value="مرفوض">مرفوض</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-control" id="causeFilter">
                                <option value="">جميع الأسباب</option>
                                <option value="قصف جوي">قصف جوي</option>
                                <option value="قصف مدفعي">قصف مدفعي</option>
                                <option value="رصاص قناص">رصاص قناص</option>
                                <option value="انفجار قذيفة">انفجار قذيفة</option>
                                <option value="مرض بسبب الحرب">مرض بسبب الحرب</option>
                                <option value="نقص في العلاج">نقص في العلاج</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="bi bi-funnel me-1"></i>فلترة
                            </button>
                        </div>
                    </div>

                    <!-- جدول الطلبات -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>معرف الطلب</th>
                                    <th>تاريخ التسجيل</th>
                                    <th>اسم الشهيد</th>
                                    <th>رقم الهوية</th>
                                    <th>تاريخ الاستشهاد</th>
                                    <th>مكان الاستشهاد</th>
                                    <th>سبب الاستشهاد</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="requestsTableBody">
                                <!-- سيتم ملؤها بواسطة JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div id="loadingSpinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">جاري التحميل...</span>
                        </div>
                    </div>

                    <div id="noData" class="text-center py-5" style="display: none;">
                        <i class="bi bi-inbox display-4 text-muted"></i>
                        <p class="text-muted mt-3">لا توجد طلبات لعرضها</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal تفاصيل الطلب -->
    <div class="modal fade" id="requestDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-info-circle me-2"></i>تفاصيل طلب الشهيد
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="requestDetailsBody">
                    <!-- سيتم ملؤها بواسطة JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal تغيير الحالة -->
    <div class="modal fade" id="statusUpdateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear me-2"></i>تغيير حالة الطلب
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">الحالة الجديدة:</label>
                        <select class="form-control" id="newStatus">
                            <option value="جديد">جديد</option>
                            <option value="قيد المراجعة">قيد المراجعة</option>
                            <option value="موافق عليه">موافق عليه</option>
                            <option value="مرفوض">مرفوض</option>
                        </select>
                    </div>
                    <input type="hidden" id="currentRequestId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="updateStatus()">تحديث الحالة</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="script.js"></script>

    <script>
        let martyrRequests = [];
        let filteredRequests = [];

        // التحقق من تسجيل الدخول
        document.addEventListener('DOMContentLoaded', function() {
            if (!App.isAdminLoggedIn()) {
                window.location.href = 'index.html';
                return;
            }
            
            loadMartyrRequests();
        });

        // تحميل طلبات الشهداء
        async function loadMartyrRequests() {
            try {
                const token = sessionStorage.getItem('adminToken');
                const response = await App.postToAPI({ action: 'getMartyrRequests', token });
                
                if (response.success) {
                    martyrRequests = response.data || [];
                    filteredRequests = martyrRequests;
                    renderRequests();
                    updateStatistics();
                } else {
                    throw new Error(response.message || 'فشل تحميل البيانات');
                }
            } catch (error) {
                App.showToast('خطأ في تحميل البيانات: ' + error.message, false);
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('noData').style.display = 'block';
            }
        }

        // عرض الطلبات
        function renderRequests() {
            const tbody = document.getElementById('requestsTableBody');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const noData = document.getElementById('noData');
            
            loadingSpinner.style.display = 'none';
            
            if (!filteredRequests || filteredRequests.length === 0) {
                tbody.innerHTML = '';
                noData.style.display = 'block';
                return;
            }
            
            noData.style.display = 'none';
            
            tbody.innerHTML = filteredRequests.map(request => {
                const statusClass = getStatusClass(request['حالة الطلب']);
                const martyrdomDate = new Date(request['تاريخ الاستشهاد']).toLocaleDateString('ar-EG');
                const registrationDate = new Date(request['تاريخ التسجيل']).toLocaleDateString('ar-EG');
                
                return `
                    <tr>
                        <td><code>${request['معرف الطلب']}</code></td>
                        <td>${registrationDate}</td>
                        <td><strong>${request['اسم الشهيد']}</strong></td>
                        <td>${request['رقم هوية الشهيد']}</td>
                        <td>${martyrdomDate}</td>
                        <td>${request['مكان الاستشهاد']}</td>
                        <td><span class="badge bg-secondary">${request['سبب الاستشهاد']}</span></td>
                        <td><span class="badge ${statusClass}">${request['حالة الطلب']}</span></td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-outline-info" onclick="viewDetails('${request['معرف الطلب']}')" title="عرض التفاصيل">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="openStatusModal('${request['معرف الطلب']}', '${request['حالة الطلب']}')" title="تغيير الحالة">
                                    <i class="bi bi-gear"></i>
                                </button>
                                ${request['رابط شهادة الوفاة'] ? `
                                <button class="btn btn-sm btn-outline-success" onclick="window.open('${request['رابط شهادة الوفاة']}', '_blank')" title="عرض شهادة الوفاة">
                                    <i class="bi bi-file-earmark-pdf"></i>
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // تحديث الإحصائيات
        function updateStatistics() {
            const total = martyrRequests.length;
            const pending = martyrRequests.filter(r => r['حالة الطلب'] === 'قيد المراجعة').length;
            const approved = martyrRequests.filter(r => r['حالة الطلب'] === 'موافق عليه').length;
            
            const thisMonth = new Date();
            const thisMonthMartyrs = martyrRequests.filter(r => {
                const martyrdomDate = new Date(r['تاريخ الاستشهاد']);
                return martyrdomDate.getMonth() === thisMonth.getMonth() && 
                       martyrdomDate.getFullYear() === thisMonth.getFullYear();
            }).length;
            
            document.getElementById('totalMartyrs').textContent = total;
            document.getElementById('pendingRequests').textContent = pending;
            document.getElementById('approvedRequests').textContent = approved;
            document.getElementById('thisMonthMartyrs').textContent = thisMonthMartyrs;
        }

        // عرض تفاصيل الطلب
        function viewDetails(requestId) {
            const request = martyrRequests.find(r => r['معرف الطلب'] === requestId);
            if (!request) return;
            
            const registrationDate = new Date(request['تاريخ التسجيل']).toLocaleDateString('ar-EG');
            const martyrdomDate = new Date(request['تاريخ الاستشهاد']).toLocaleDateString('ar-EG');
            
            const detailsHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-person-fill me-2"></i>بيانات الشهيد</h6>
                        <ul class="list-unstyled">
                            <li><strong>الاسم:</strong> ${request['اسم الشهيد']}</li>
                            <li><strong>رقم الهوية:</strong> ${request['رقم هوية الشهيد']}</li>
                            <li><strong>تاريخ الاستشهاد:</strong> ${martyrdomDate}</li>
                            <li><strong>مكان الاستشهاد:</strong> ${request['مكان الاستشهاد']}</li>
                            <li><strong>سبب الاستشهاد:</strong> ${request['سبب الاستشهاد']}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-info-circle me-2"></i>معلومات الطلب</h6>
                        <ul class="list-unstyled">
                            <li><strong>معرف الطلب:</strong> <code>${request['معرف الطلب']}</code></li>
                            <li><strong>تاريخ التسجيل:</strong> ${registrationDate}</li>
                            <li><strong>الحالة:</strong> <span class="badge ${getStatusClass(request['حالة الطلب'])}">${request['حالة الطلب']}</span></li>
                        </ul>
                    </div>
                </div>
                
                ${request['تفاصيل إضافية'] ? `
                <hr>
                <h6><i class="bi bi-chat-text me-2"></i>تفاصيل إضافية</h6>
                <p class="bg-light p-3 rounded">${request['تفاصيل إضافية']}</p>
                ` : ''}
                
                ${request['رابط شهادة الوفاة'] ? `
                <hr>
                <h6><i class="bi bi-file-earmark-pdf me-2"></i>المرفقات</h6>
                <a href="${request['رابط شهادة الوفاة']}" target="_blank" class="btn btn-outline-success">
                    <i class="bi bi-download me-1"></i>عرض شهادة الوفاة
                </a>
                ` : ''}
            `;
            
            document.getElementById('requestDetailsBody').innerHTML = detailsHtml;
            new bootstrap.Modal(document.getElementById('requestDetailsModal')).show();
        }

        // فتح نافذة تغيير الحالة
        function openStatusModal(requestId, currentStatus) {
            document.getElementById('currentRequestId').value = requestId;
            document.getElementById('newStatus').value = currentStatus;
            new bootstrap.Modal(document.getElementById('statusUpdateModal')).show();
        }

        // تحديث حالة الطلب
        async function updateStatus() {
            try {
                const requestId = document.getElementById('currentRequestId').value;
                const newStatus = document.getElementById('newStatus').value;
                const token = sessionStorage.getItem('adminToken');
                
                const response = await App.postToAPI({
                    action: 'updateMartyrRequestStatus',
                    token,
                    requestId,
                    newStatus
                });
                
                if (response.success) {
                    App.showToast('تم تحديث حالة الطلب بنجاح', true);
                    bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal')).hide();
                    await loadMartyrRequests();
                } else {
                    throw new Error(response.message || 'فشل تحديث الحالة');
                }
            } catch (error) {
                App.showToast('خطأ في تحديث الحالة: ' + error.message, false);
            }
        }

        // تطبيق الفلاتر
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const causeFilter = document.getElementById('causeFilter').value;
            
            filteredRequests = martyrRequests.filter(request => {
                const matchesSearch = !searchTerm || 
                    request['اسم الشهيد'].toLowerCase().includes(searchTerm) ||
                    request['رقم هوية الشهيد'].includes(searchTerm);
                    
                const matchesStatus = !statusFilter || request['حالة الطلب'] === statusFilter;
                const matchesCause = !causeFilter || request['سبب الاستشهاد'] === causeFilter;
                
                return matchesSearch && matchesStatus && matchesCause;
            });
            
            renderRequests();
        }

        // تحديث البيانات
        function refreshRequests() {
            loadMartyrRequests();
        }

        // تصدير إلى Excel
        function exportToExcel() {
            if (!filteredRequests.length) {
                App.showToast('لا توجد بيانات للتصدير', false);
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(filteredRequests);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "الشهداء");
            XLSX.writeFile(wb, `شهداء-عائلة-أبو-رجيلة-${new Date().toLocaleDateString('ar-EG')}.xlsx`);
            App.showToast('تم تصدير البيانات بنجاح', true);
        }

        // الحصول على class الحالة
        function getStatusClass(status) {
            switch (status) {
                case 'جديد': return 'bg-primary';
                case 'قيد المراجعة': return 'bg-warning';
                case 'موافق عليه': return 'bg-success';
                case 'مرفوض': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        // البحث أثناء الكتابة
        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('causeFilter').addEventListener('change', applyFilters);
    </script>
</body>
</html>
